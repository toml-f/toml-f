

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Building a linter &#8212; TOML Fortran</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial/fpm-lint';</script>
    <link rel="icon" href="../_static/toml-f.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Writing a custom lexer" href="json.html" />
    <link rel="prev" title="Converting from Namelist to TOML" href="namelist-to-toml.html" /> 
<meta
  name="description"
  content="TOML parser implementation for data serialization and deserialization in Fortran"
/>
<meta
  name="keywords"
  content="TOML parser, TOML, serde, Fortran library, Fortran package manager"
/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/toml-f.svg" class="logo__image only-light" alt="TOML Fortran - Home"/>
    <img src="../_static/toml-f.svg" class="logo__image only-dark pst-js-only" alt="TOML Fortran - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="namelist-to-toml.html">Converting from Namelist to TOML</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Building a linter</a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html">Writing a custom lexer</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../how-to/index.html">How-Tos</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../how-to/installation.html">Installing TOML Fortran</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/integration.html">Using TOML Fortran</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/table.html">Working with tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/array.html">Working with arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/error.html">Reporting errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/datetime.html">Date time compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/serde.html">Serializable base class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/jonquil.html">Compatibility with JSON</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">References</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://toml.io/en/v1.0.0">TOML specification</a></li>
<li class="toctree-l2"><a class="reference external" href="https://toml-f.github.io/toml-f">API documentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../external.html">External resources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://cyber.dabamos.de/programming/modernfortran/toml.html">Modern Fortran by Philipp Engel (English)</a></li>
<li class="toctree-l2"><a class="reference external" href="https://fortran-fans.github.io/Fortran-in-Action/Using-Open-Source-Code/Project-Configuration-TOML-F.html">Fortran in Action by Zuo Zhihua (Chinese)</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/toml-f/toml-f" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/toml-f/toml-f/edit/main/doc/tutorial/fpm-lint.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Building a linter</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#target-selection">Target selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-of-the-linter">Configuration of the linter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-package-name">Recommended package name</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bare-key-paths-preferred">Bare key paths preferred</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section id="building-a-linter">
<h1>Building a linter<a class="headerlink" href="#building-a-linter" title="Permalink to this heading">#</a></h1>
<img alt="Difficulty: Beginner" src="https://img.shields.io/badge/difficulty-beginner-brightgreen" />
<p>This tutorial will show how to use TOML Fortran to build a linter for your configuration files.
Linters provide a way to encourage or enforce a certain style or flag up common usage errors.</p>
<section id="target-selection">
<h2>Target selection<a class="headerlink" href="#target-selection" title="Permalink to this heading">#</a></h2>
<p>This tutorial will look into finding lint in the package manifest from the Fortran package manager (<a class="reference external" href="https://fpm.fortran-lang.org">fpm</a>).
We will use its plugin mechanism to create a new subcommand called <code class="docutils literal notranslate"><span class="pre">lint</span></code>.</p>
<p>We start with setting up the package manifest for our linter:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id1" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpm-lint&quot;</span>
<span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.1.0&quot;</span>

<span class="k">[dependencies]</span>
<span class="n">toml-f</span><span class="p">.</span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/toml-lang/toml-f.git&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="configuration-of-the-linter">
<h2>Configuration of the linter<a class="headerlink" href="#configuration-of-the-linter" title="Permalink to this heading">#</a></h2>
<p>To configure our linter we will use the <a class="reference external" href="https://fpm.fortran-lang.org/en/spec/manifest.html#additional-free-data-field">extra section</a> in the manifest which is specially reserved for tools integrating with fpm and boldly claim <em>extra.fpm.lint</em> as our configuration section.
Using the package manifest provides us with two advantages, first this document will be present in all projects using fpm, second if we can read our configuration from the manifest, we are already sure it is valid TOML.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id2" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="c1"># ...</span>
<span class="k">[extra.fpm.lint]</span>
<span class="n">package-name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="n">bare-keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</pre></div>
</div>
</div>
<p>Now we will set up our main program to run the linter.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">app/main.f90</span><a class="headerlink" href="#id3" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">main</span>
<span class="w">  </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_fortran_env</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">output_unit</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_utils</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_load</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">  </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">manifest</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">manifest</span><span class="p">))</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpm.toml&quot;</span>

<span class="w">  </span><span class="k">call </span><span class="n">toml_load</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">config</span><span class="o">=</span><span class="n">toml_parser_config</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">))</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">contains</span>

<span class="k">  subroutine </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">%</span><span class="n">message</span>
<span class="w">      </span><span class="k">stop </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">handle_error</span>

<span class="k">end program </span><span class="n">main</span>
</pre></div>
</div>
</div>
<p>We create a utility module for the <em>get_argument</em> function used to retrieve the manifest name, in most cases we can default to <em>fpm.toml</em>, but for testing it is convenient to pass an argument.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">src/utils.f90</span><a class="headerlink" href="#id4" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Misc utilities for the fpm-lint implementation</span>
<span class="k">module </span><span class="n">fpm_lint_utils</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">get_argument</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Obtain the command line argument at a given index</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">get_argument</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Index of command line argument, range [0:command_argument_count()]</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">idx</span>
<span class="w">    </span><span class="c">!&gt; Command line argument</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arg</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">    </span><span class="k">call </span><span class="nb">get_command_argument</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="nb">get_command_argument</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">arg</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">get_argument</span>

<span class="k">end module </span><span class="n">fpm_lint_utils</span>
</pre></div>
</div>
</div>
<p>The first error source we can encounter stems from parsing the TOML document itself.
This is outside of our responsibility to handle, still we want to check whether we can report the error correctly.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">fpm.toml (invalid)</span><a class="headerlink" href="#id5" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span>name = &quot;demo&quot;

[extra.fpm.lint]
package-name =
bare-keys = true
</pre></div>
</div>
</div>
<p>Running the linter on this document will break with the following message produced by the <em>toml_load</em> procedure.</p>
<pre class="ansi-block highlight literal-block">‚ùØ fpm run -- invalid.toml
<span class="ansi-bold ansi-red">error</span><span class="ansi-bold">: Invalid expression for value</span>
 <span class="ansi-bold ansi-blue">--&gt;</span> invalid.toml:4:15
  <span class="ansi-bold ansi-blue">|</span>
4 <span class="ansi-bold ansi-blue">|</span> package-name =
  <span class="ansi-bold ansi-blue">|</span>               <span class="ansi-bold ansi-red">^</span> <span class="ansi-bold ansi-red">unexpected newline</span>
  <span class="ansi-bold ansi-blue">|</span></pre>
<p>With this case covered we proceed with reading the configuration for our linter.</p>
<p>Our configuration from the package manifest will be stored in a <em>lint_config</em> type which we define in a separate module.
Reading the configuration will happen from the root table, meaning we have to advance through several subtables first before we can process the options for our linter.
We want to report errors with rich context information here as well, therefore we request the <em>origin</em> in every call to the <em>get_value</em> interface and produce a report using the <em>context</em> we obtained in the main program.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">src/config.f90</span><a class="headerlink" href="#id6" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Configuration data for the manifest linting</span>
<span class="k">module </span><span class="n">fpm_lint_config</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span>
<span class="w">  </span><span class="k">implicit none</span>

<span class="w">  </span><span class="c">!&gt; Configuration for the manifest linting</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_config</span>
<span class="w">    </span><span class="c">!&gt; Check package name</span>
<span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">package_name</span>
<span class="w">    </span><span class="c">!&gt; Check all key paths</span>
<span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bare_keys</span>
<span class="w">  </span><span class="k">end type </span><span class="n">lint_config</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Load the configuration for the linter from the package manifest</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">load_lint_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Configuration for the linter</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure representing the manifest</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Context describing the data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">    </span><span class="c">!&gt; Terminal for output</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span>
<span class="nb">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child1</span><span class="p">,</span><span class="w"> </span><span class="n">child2</span><span class="p">,</span><span class="w"> </span><span class="n">child3</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;extra&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child1</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;The &#39;extra&#39; table is missing.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expected table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">child1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;fpm&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child2</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child2</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;The &#39;fpm&#39; table is missing.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expected table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">child2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;lint&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child3</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child3</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;The &#39;lint&#39; table is missing.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expected table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">child3</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;package-name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">package_name</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Entry in &#39;package-name&#39; must be boolean&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expected boolean value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">child3</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;bare-keys&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">bare_keys</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Entry in &#39;bare-key&#39; must be boolean&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">        </span><span class="p">&amp;</span><span class="w"> </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;expected boolean value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">  end subroutine </span><span class="n">load_lint_config</span>

<span class="w">  </span><span class="c">!&gt; Create an error message</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Message to be displayed</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>

<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="n">error</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span>
<span class="w">    </span><span class="n">error</span><span class="p">%</span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">fatal</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">make_error</span>

<span class="k">end module </span><span class="n">fpm_lint_config</span>
</pre></div>
</div>
</div>
<p>For convenience, we defined a <em>make_error</em> routine to allocate the error handler and store our report from the context.
At this point, we should check whether our error reporting works and run the linter on an incorrect TOML document.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id7" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;demo&quot;</span>

<span class="k">[extra.fpm.lint]</span>
<span class="n">package-name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="n">bare-keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</pre></div>
</div>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">current main program</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Putting everything together in the main program should look like this.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">app/main.f90</span><a class="headerlink" href="#id8" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">main</span>
<span class="w">  </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_fortran_env</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">output_unit</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_config</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">load_lint_config</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_utils</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_load</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_terminal</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">  </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">manifest</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">  </span><span class="n">terminal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">manifest</span><span class="p">))</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpm.toml&quot;</span>

<span class="w">  </span><span class="k">call </span><span class="n">toml_load</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">config</span><span class="o">=</span><span class="n">toml_parser_config</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">load_lint_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="k">contains</span>

<span class="k">  subroutine </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">%</span><span class="n">message</span>
<span class="w">      </span><span class="k">stop </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">handle_error</span>

<span class="k">end program </span><span class="n">main</span>
</pre></div>
</div>
</div>
</div>
</details><p>Running our linter on this file will correctly flag this as an error since a string value is provided rather than a boolean value.</p>
<pre class="ansi-block highlight literal-block">‚ùØ fpm run -- fpm.toml
<span class="ansi-bold ansi-red">error</span><span class="ansi-bold">: Entry in 'package-name' must be boolean</span>
 <span class="ansi-bold ansi-blue">--&gt;</span> fpm.toml:4:16-21
  <span class="ansi-bold ansi-blue">|</span>
4 <span class="ansi-bold ansi-blue">|</span> package-name = &quot;true&quot;
  <span class="ansi-bold ansi-blue">|</span>                <span class="ansi-bold ansi-red">^^^^^^</span> <span class="ansi-bold ansi-red">expected boolean value</span>
  <span class="ansi-bold ansi-blue">|</span></pre>
<p>Finally, we define a logging mechanism to capture our actual linting messages which are not fatal.
The logger provides two procedures, <em>add_message</em> to store a message and <em>show_log</em> to display all stored messages.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">src/logger.f90</span><a class="headerlink" href="#id9" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">fpm_lint_logger</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_logger</span><span class="p">,</span><span class="w"> </span><span class="n">new_logger</span>


<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">log_message</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">output</span>
<span class="w">  </span><span class="k">end type </span><span class="n">log_message</span>

<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_logger</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">log_message</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span><span class="p">(:)</span>
<span class="w">  </span><span class="k">contains</span>
<span class="k">    procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">add_message</span>
<span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">show_log</span>
<span class="w">  </span><span class="k">end type </span><span class="n">lint_logger</span>

<span class="k">contains</span>

<span class="k">  subroutine </span><span class="n">new_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>

<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">logger</span><span class="p">%</span><span class="n">message</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">new_logger</span>

<span class="w">  </span><span class="k">subroutine </span><span class="n">add_message</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">)</span>
<span class="w">    </span><span class="k">class</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>

<span class="w">    </span><span class="n">logger</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">logger</span><span class="p">%</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">log_message</span><span class="p">(</span><span class="n">message</span><span class="p">)]</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">add_message</span>

<span class="w">  </span><span class="k">subroutine </span><span class="n">show_log</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">)</span>
<span class="w">    </span><span class="k">class</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">io</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span>

<span class="w">    </span><span class="k">do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">logger</span><span class="p">%</span><span class="n">message</span><span class="p">)</span>
<span class="w">      </span><span class="k">write</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">logger</span><span class="p">%</span><span class="n">message</span><span class="p">(</span><span class="n">it</span><span class="p">)%</span><span class="n">output</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">  end subroutine </span><span class="n">show_log</span>

<span class="k">end module </span><span class="n">fpm_lint_logger</span>
</pre></div>
</div>
</div>
</section>
<section id="recommended-package-name">
<h2>Recommended package name<a class="headerlink" href="#recommended-package-name" title="Permalink to this heading">#</a></h2>
<p>As a first linting check we will inspect the package name, for this we will apply the following rules:</p>
<ol class="arabic simple">
<li><p>the package name should be a TOML bare key to not require quotes in <em>dependency</em> sections, characters like dots, colons, or slashes are not allowed</p></li>
<li><p>TOML generally favors lowercase dashed keys, therefore we will discourage capitalization (camelCase and PascalCase) as well as underscores (snake_case)</p></li>
<li><p>there are several ways to declare strings in TOML, we want to favor the normal string one</p></li>
</ol>
<p>An example of a package name we would disallow would be <em>fpmLinter</em> as seen in the manifest below.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id10" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpmLinter&quot;</span>
</pre></div>
</div>
</div>
<p>Let‚Äôs start with our implementation of this check.
For convenience we will reexport the other modules from the <em>fpm_lint</em> module, this allows one clean import in the main program.
Then we define the <em>lint_data</em> procedure, where we first check whether the <em>name</em> key is present, if not we create a message at the <em>info</em> level and leave our block scope, as all further checks rely on the presence of the entry.</p>
<p>We can now check whether the entry is provided as a string or maybe as something else, like a literal string, which we can flag.
Furthermore, we verify that the package name uses only lowercase letters, numbers, and dashes with the <em>verify</em> intrinsic.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">src/lint.f90</span><a class="headerlink" href="#id11" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Linter for package manifests used with the Fortran package manager</span>
<span class="k">module </span><span class="n">fpm_lint</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_config</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">load_lint_config</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_logger</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lint_logger</span><span class="p">,</span><span class="w"> </span><span class="n">new_logger</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint_utils</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">resize</span><span class="p">,</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">toml_level</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_key</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf_de_token</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">token_kind</span><span class="p">,</span><span class="w"> </span><span class="n">stringify</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">load_lint_config</span>
<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_logger</span><span class="p">,</span><span class="w"> </span><span class="n">new_logger</span>
<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lint_data</span>
<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">get_argument</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Entry point for linting the data structure representing the package manifest</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">lint_data</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Instance of the logger</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">    </span><span class="c">!&gt; Configuration for the linter</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Context describing the data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">    </span><span class="c">!&gt; Terminal for output</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">%</span><span class="n">package_name</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">check_package_name</span><span class="p">:</span><span class="w"> </span><span class="k">block</span>
<span class="k">        </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">package_name</span>
<span class="w">        </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">origin</span>

<span class="w">        </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">package_name</span><span class="p">,</span><span class="w"> </span><span class="n">origin</span><span class="o">=</span><span class="n">origin</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">package_name</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">logger</span><span class="p">%</span><span class="n">add_message</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="s2">&quot;Package name entry is required in the top-level&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">level</span><span class="o">=</span><span class="n">toml_level</span><span class="p">%</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">          </span><span class="k">exit </span><span class="n">check_package_name</span>
<span class="w">        </span><span class="k">end if</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">origin</span><span class="p">)%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">logger</span><span class="p">%</span><span class="n">add_message</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="s2">&quot;Package name should not be a &quot;</span><span class="o">//</span><span class="n">stringify</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">origin</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="s2">&quot;prefer string value (double quotes)&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">level</span><span class="o">=</span><span class="n">toml_level</span><span class="p">%</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">        </span><span class="k">end if</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">package_name</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz0123456789-&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">logger</span><span class="p">%</span><span class="n">add_message</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="s2">&quot;Package name should be lowercase with dashes&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="n">level</span><span class="o">=</span><span class="n">toml_level</span><span class="p">%</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">        </span><span class="k">end if</span>
<span class="k">      end block </span><span class="n">check_package_name</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">  end subroutine </span><span class="n">lint_data</span>

<span class="k">end module </span><span class="n">fpm_lint</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code class="docutils literal notranslate"><span class="pre">toml_level</span></code> parameter provides a statically initialized derived type enumerating all available report levels.
Similarly, the <code class="docutils literal notranslate"><span class="pre">token_kind</span></code> parameter provides an enumeration of the token kinds.
You can think of it as an enumerator with a proper namespace.</p>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">current main program</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Putting everything together in the main program should look like this.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">app/main.f90</span><a class="headerlink" href="#id12" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">main</span>
<span class="w">  </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_fortran_env</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">output_unit</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">load_lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">lint_logger</span><span class="p">,</span><span class="w"> </span><span class="n">new_logger</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">lint_data</span><span class="p">,</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_load</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_terminal</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">manifest</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">  </span><span class="n">terminal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">manifest</span><span class="p">))</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpm.toml&quot;</span>

<span class="w">  </span><span class="k">call </span><span class="n">toml_load</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">config</span><span class="o">=</span><span class="n">toml_parser_config</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">context_detail</span><span class="o">=</span><span class="n">detail</span><span class="p">))</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">load_lint_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">new_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">lint_data</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">logger</span><span class="p">%</span><span class="n">show_log</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="k">contains</span>

<span class="k">  subroutine </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">%</span><span class="n">message</span>
<span class="w">      </span><span class="k">stop </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">handle_error</span>

<span class="k">end program </span><span class="n">main</span>
</pre></div>
</div>
</div>
</div>
</details><p>We check this on the camelCase package name from above and can find the following output.</p>
<pre class="ansi-block highlight literal-block">‚ùØ fpm run -- fpm.toml
<span class="ansi-bold ansi-magenta">info</span><span class="ansi-bold">: Package name should be lowercase with dashes</span>
 <span class="ansi-bold ansi-blue">--&gt;</span> fpm.toml:1:8-18
  <span class="ansi-bold ansi-blue">|</span>
1 <span class="ansi-bold ansi-blue">|</span> name = &quot;fpmLinter&quot;
  <span class="ansi-bold ansi-blue">|</span>        <span class="ansi-bold ansi-magenta">^^^^^^^^^^^</span>
  <span class="ansi-bold ansi-blue">|</span></pre>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>Add a check for the length of the package name, everything under three characters is probably a bad choice, so is a too long package name.</p>
<p>Create an example to trigger the error with your new check.
What happens if a too long camelCase package name is used?</p>
</div>
</section>
<section id="bare-key-paths-preferred">
<h2>Bare key paths preferred<a class="headerlink" href="#bare-key-paths-preferred" title="Permalink to this heading">#</a></h2>
<p>TOML allows to quote keys, however this might become visually distracting if some keys are quoted and others are not.
With our package name rule, there should not be the need to quote any keys even in dependency sections.</p>
<p>To determine whether a string is used in the context of a key we need a way to identify all keys.
We could check all entries in the data structures by implementing a visitor object which walks through all tables and checks the keys.
However, this is somewhat inefficient and we can also miss keys that are not recorded.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id13" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;demo&quot;</span>

<span class="k">[dependencies]</span>
<span class="n">toml-f</span><span class="p">.</span><span class="n">git</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/toml-f/toml-f&quot;</span>
<span class="s2">&quot;toml-f&quot;</span><span class="p">.</span><span class="n">tag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;v0.2.3&quot;</span>
</pre></div>
</div>
</div>
<p>In this example, the second occurrence of the key <code class="docutils literal notranslate"><span class="pre">toml-f</span></code> will only reference the table but it is already defined the line before.
The quotation marks are visually identifiable as lint and we need a programmatic way to flag this.</p>
<p>Instead of working with the data structure, we will use the parser to record more tokens in the context.
Rather than using the context to only report errors, we will use it to identify keys.
This is done by increasing the <em>context_detail</em> option in the <em>config</em> keyword of the parser to one.
Now all tokens except for whitespace and comments will be recorded.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">app/main.f90</span><a class="headerlink" href="#id14" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">call </span><span class="n">toml_load</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">  </span><span class="p">&amp;</span><span class="w"> </span><span class="n">config</span><span class="o">=</span><span class="n">toml_parser_config</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span><span class="w"> </span><span class="n">context_detail</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Increasing the <code class="docutils literal notranslate"><span class="pre">context_detail</span></code> to two will also record whitespace and comments.
This can be useful when writing checks for whitespace or indentation styles.</p>
</div>
<p>Our linter pass will work as follows:</p>
<ol class="arabic simple">
<li><p>identifying all relevant keys in the manifest</p></li>
<li><p>check whether they are keypath tokens</p></li>
<li><p>create a report for any key that is a string or a literal</p></li>
</ol>
<p>Our implementation reflects this by first collecting an array of <em>toml_key</em> objects in <em>list</em> and then iterating over all entries checking whether they are the correct <em>token_kind</em>.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">src/lint.f90</span><a class="headerlink" href="#id15" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Entry point for linting the keys in the TOML document</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">lint_keys</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Instance of the logger</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">    </span><span class="c">!&gt; Configuration for the linter</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">    </span><span class="c">!&gt; Context describing the data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">    </span><span class="c">!&gt; Terminal for output</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list</span><span class="p">(:)</span>

<span class="w">    </span><span class="k">call </span><span class="n">identify_keys</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="p">%</span><span class="n">bare_keys</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">        </span><span class="k">associate</span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">it</span><span class="p">)%</span><span class="n">origin</span><span class="p">))</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">logger</span><span class="p">%</span><span class="n">add_message</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">report</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">              </span><span class="s2">&quot;String used in key path&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">              </span><span class="n">list</span><span class="p">(</span><span class="n">it</span><span class="p">)%</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">              </span><span class="s2">&quot;use bare key instead&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">              </span><span class="n">level</span><span class="o">=</span><span class="n">toml_level</span><span class="p">%</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">))</span>
<span class="w">          </span><span class="k">end if</span>
<span class="k">        end associate</span>
<span class="k">      end do</span>
<span class="k">    end if</span>
<span class="k">  end subroutine </span><span class="n">lint_keys</span>
</pre></div>
</div>
</div>
<p>To create the list we need to implement the <em>identify_keys</em> procedure.
The rules in TOML for key paths are simple: before an equal sign we can have key paths and keypath can only be present in table bodies or inline tables.
This can be implemented by using a stack storing whether the current scope belongs in a table, array, or value.</p>
<p>We will always push a new scope on the respective token opening it, <em>i.e.</em> a value is opened by an equal sign, an array by a right bracket, and an inline table by a right curly brace.
To distinguish table headers from inline arrays we only push arrays on our stack after an equal sign.
Finally, we default to a table scope if no other scope is present and we have collected all required rules to identify key paths.
Similarly, we can identify the endings of the scopes.</p>
<p>We then can check whether the current scope on the top of the stack allows key paths and record those in our list.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">src/lint.f90</span><a class="headerlink" href="#id16" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Collect all key paths used in TOML document</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">identify_keys</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; List of all keypaths in the TOML document</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list</span><span class="p">(:)</span>
<span class="w">    </span><span class="c">!&gt; Context describing the data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>

<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">array_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">value_scope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">top</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scopes</span><span class="p">(:)</span>

<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="w">    </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="k">call </span><span class="n">resize</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>

<span class="w">    </span><span class="c">! Documents always start with a table scope</span>
<span class="w">    </span><span class="k">call </span><span class="n">push_back</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">table_scope</span><span class="p">)</span>
<span class="w">    </span><span class="k">do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">top</span>
<span class="w">      </span><span class="k">select case</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">it</span><span class="p">)%</span><span class="nb">kind</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">)</span>
<span class="w">        </span><span class="c">! Record all key path</span>
<span class="w">        </span><span class="k">associate</span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
<span class="w">          </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">),</span><span class="w"> </span><span class="n">it</span><span class="p">)]</span>
<span class="w">        </span><span class="k">end associate</span>

<span class="k">      case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">literal</span><span class="p">)</span>
<span class="w">        </span><span class="c">! Record all strings used in key paths</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopes</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">table_scope</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          associate</span><span class="p">(</span><span class="n">token</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">%</span><span class="n">token</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
<span class="w">            </span><span class="n">list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span><span class="p">(</span><span class="n">context</span><span class="p">%</span><span class="n">source</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">it</span><span class="p">)]</span>
<span class="w">          </span><span class="k">end associate</span>
<span class="k">        end if</span>

<span class="k">      case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">equal</span><span class="p">)</span><span class="w">  </span><span class="c">! Open value scope</span>
<span class="w">        </span><span class="k">call </span><span class="n">push_back</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">value_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbrace</span><span class="p">)</span><span class="w">  </span><span class="c">! Open inline table scope</span>
<span class="w">        </span><span class="k">call </span><span class="n">push_back</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">table_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbracket</span><span class="p">)</span><span class="w">  </span><span class="c">! Open array scope</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">scopes</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">table_scope</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">push_back</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">array_scope</span><span class="p">)</span>
<span class="w">        </span><span class="k">end if</span>

<span class="k">      case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">newline</span><span class="p">)</span><span class="w">  </span><span class="c">! Close value scope in key-value pair </span>
<span class="w">        </span><span class="k">call </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">value_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbrace</span><span class="p">)</span><span class="w">  </span><span class="c">! Close value and table scope in inline table</span>
<span class="w">        </span><span class="k">call </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">value_scope</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">table_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">)</span><span class="w">  </span><span class="c">! Close value scope in inline table</span>
<span class="w">        </span><span class="k">call </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">value_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbracket</span><span class="p">)</span><span class="w">  </span><span class="c">! Close array scope</span>
<span class="w">        </span><span class="k">call </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">array_scope</span><span class="p">)</span>

<span class="w">      </span><span class="k">end select</span>
<span class="k">    end do</span>

<span class="k">  contains</span>

<span class="w">    </span><span class="c">!&gt; Push a new scope onto the stack</span>
<span class="w">    </span><span class="k">pure subroutine </span><span class="n">push_back</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">this_scope</span><span class="p">)</span>
<span class="w">      </span><span class="c">!&gt; Stack top</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">top</span>
<span class="w">      </span><span class="c">!&gt; Current stack of scopes</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scopes</span><span class="p">(:)</span>
<span class="w">      </span><span class="c">!&gt; Scope to push onto the stack</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">this_scope</span>

<span class="w">      </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">top</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">scopes</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">resize</span><span class="p">(</span><span class="n">scopes</span><span class="p">)</span>
<span class="w">      </span><span class="n">scopes</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_scope</span>
<span class="w">    </span><span class="k">end subroutine </span><span class="n">push_back</span>

<span class="w">    </span><span class="c">!&gt; Remove a matching scope from the stack</span>
<span class="w">    </span><span class="k">subroutine </span><span class="n">pop</span><span class="p">(</span><span class="n">scopes</span><span class="p">,</span><span class="w"> </span><span class="n">top</span><span class="p">,</span><span class="w"> </span><span class="n">this_scope</span><span class="p">)</span>
<span class="w">      </span><span class="c">!&gt; Stack top</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">top</span>
<span class="w">      </span><span class="c">!&gt; Current stack of scopes</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scopes</span><span class="p">(:)</span>
<span class="w">      </span><span class="c">!&gt; Scope to remove from the stack</span>
<span class="w">      </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">this_scope</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">top</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">scopes</span><span class="p">(</span><span class="n">top</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">this_scope</span><span class="p">)</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">top</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">    end subroutine </span><span class="n">pop</span>

<span class="w">  </span><span class="k">end subroutine </span><span class="n">identify_keys</span>
</pre></div>
</div>
</div>
<p>For convenience, we implement a <em>push_back</em> and <em>pop</em> function to add and remove scopes from our stack.
The <em>pop</em> function will additionally perform a check whether we want to remove a matching scope and save us some repetition in the loop this way.</p>
<p>In our utility module, we implement the <em>resize</em> procedure for an array of integers</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">src/utils.f90</span><a class="headerlink" href="#id17" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Misc utilities for the fpm-lint implementation</span>
<span class="k">module </span><span class="n">fpm_lint_utils</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">resize</span>
<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">get_argument</span>

<span class="w">  </span><span class="c">!&gt; Resize a 1D array to a new size</span>
<span class="w">  </span><span class="k">interface </span><span class="n">resize</span>
<span class="w">    </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">resize_ints</span>
<span class="w">  </span><span class="k">end interface </span><span class="n">resize</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Reallocate list of integer</span>
<span class="w">  </span><span class="k">pure subroutine </span><span class="n">resize_ints</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Instance of the array to be resized</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">var</span><span class="p">(:)</span>
<span class="w">    </span><span class="c">!&gt; Dimension of the final array size</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">n</span>

<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmp</span><span class="p">(:)</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">this_size</span><span class="p">,</span><span class="w"> </span><span class="n">new_size</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">initial_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">this_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span>
<span class="w">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">this_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_size</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">new_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span>
<span class="w">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">new_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">this_size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">this_size</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    allocate</span><span class="p">(</span><span class="n">var</span><span class="p">(</span><span class="n">new_size</span><span class="p">))</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">this_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">min</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">var</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span>
<span class="w">      </span><span class="n">var</span><span class="p">(:</span><span class="n">this_size</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">(:</span><span class="n">this_size</span><span class="p">)</span>
<span class="w">      </span><span class="k">deallocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">resize_ints</span>

<span class="k">end module </span><span class="n">fpm_lint_utils</span>
</pre></div>
</div>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">current main program</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Putting everything together in the main program should look like this.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">app/main.f90</span><a class="headerlink" href="#id18" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">main</span>
<span class="w">  </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_fortran_env</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stderr</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">stdout</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">output_unit</span>
<span class="w">  </span><span class="k">use </span><span class="n">fpm_lint</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">load_lint_config</span><span class="p">,</span><span class="w"> </span><span class="n">lint_logger</span><span class="p">,</span><span class="w"> </span><span class="n">new_logger</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">lint_data</span><span class="p">,</span><span class="w"> </span><span class="n">lint_keys</span><span class="p">,</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_load</span><span class="p">,</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_terminal</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">  </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">detail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">manifest</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_terminal</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminal</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">lint_logger</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">logger</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">lint_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">  </span><span class="n">terminal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">)</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">manifest</span><span class="p">))</span><span class="w"> </span><span class="n">manifest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;fpm.toml&quot;</span>

<span class="w">  </span><span class="k">call </span><span class="n">toml_load</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">manifest</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="p">&amp;</span><span class="w"> </span><span class="n">config</span><span class="o">=</span><span class="n">toml_parser_config</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">context_detail</span><span class="o">=</span><span class="n">detail</span><span class="p">))</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">load_lint_config</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">new_logger</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">lint_data</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">)</span>
<span class="w">  </span><span class="k">call </span><span class="n">lint_keys</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">terminal</span><span class="p">)</span>

<span class="w">  </span><span class="k">call </span><span class="n">logger</span><span class="p">%</span><span class="n">show_log</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>

<span class="k">contains</span>

<span class="k">  subroutine </span><span class="n">handle_error</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">error</span><span class="p">%</span><span class="n">message</span>
<span class="w">      </span><span class="k">stop </span><span class="mi">1</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">handle_error</span>

<span class="k">end program </span><span class="n">main</span>
</pre></div>
</div>
</div>
</div>
</details><p>At this point, we can now add a call in our main program to run the linter.</p>
<pre class="ansi-block highlight literal-block">‚ùØ fpm run -- fpm.toml
<span class="ansi-bold ansi-magenta">info</span><span class="ansi-bold">: String used in key path</span>
 <span class="ansi-bold ansi-blue">--&gt;</span> fpm.toml:5:1-8
  <span class="ansi-bold ansi-blue">|</span>
5 <span class="ansi-bold ansi-blue">|</span> &quot;toml-f&quot;.tag = &quot;v0.2.3&quot;
  <span class="ansi-bold ansi-blue">|</span> <span class="ansi-bold ansi-magenta">^^^^^^^^</span> <span class="ansi-bold ansi-magenta">use bare key instead</span>
  <span class="ansi-bold ansi-blue">|</span></pre>
<p>Now for something more tricky with an inline table to check whether our scoping rules are working correctly.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">fpm.toml</span><a class="headerlink" href="#id19" title="Permalink to this code">#</a></div>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;demo&quot;</span>

<span class="k">[dependencies]</span>
<span class="n">toml-f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">git</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;https://github.com/toml-f/toml-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tag&quot;</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;v0.2.3&quot;</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Our linter can correctly identify the <em>tag</em> entry as a string in the key path context and produces the appropriate message.</p>
<pre class="ansi-block highlight literal-block">‚ùØ fpm run -- fpm.toml
<span class="ansi-bold ansi-magenta">info</span><span class="ansi-bold">: String used in key path</span>
 <span class="ansi-bold ansi-blue">--&gt;</span> fpm.toml:4:53-57
  <span class="ansi-bold ansi-blue">|</span>
4 <span class="ansi-bold ansi-blue">|</span> toml-f = {git = &quot;https://github.com/toml-f/toml-f&quot;, &quot;tag&quot; = &quot;v0.2.3&quot;}
  <span class="ansi-bold ansi-blue">|</span>                                                     <span class="ansi-bold ansi-magenta">^^^^^</span> <span class="ansi-bold ansi-magenta">use bare key instead</span>
  <span class="ansi-bold ansi-blue">|</span></pre>
<div class="note admonition">
<p class="admonition-title">Exercise</p>
<p>Previously, we flagged the usage of a literal string as a value for the package name, however a package manifest can contain much more string values.</p>
<p>Create a check for all string values in the manifest to ensure they use double-quotes.
Collect string values (<em>string</em>, <em>literal</em>, <em>mstring</em>, and <em>mliteral</em>) from array and value scopes for this purpose.</p>
<p>Can you make a meaningful suggestion if a literal string contains characters that must be escaped in a double-quoted string?</p>
</div>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p>This concludes the linting we wanted to implement for the fpm package manifest.
For a feature-complete linter, the rule set to check for is usually growing with time and might also shift as new rules are adopted.
Our linter currently provides only a few rules but has the potential to include more checks as the need arises.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Our output is currently in the order of the checks, rather than in the order of reports occurring in the TOML document.
The output of the reports might become more intuitive if it was sorted according to the source lines.</p>
<p>Record the first character in the output together with the messages in the logger.
Have the logger sort the messages according to their order before printing them.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In this tutorial, you have learned how to report custom error messages in your TOML input data.
You can now</p>
<ul class="simple">
<li><p>report colorized error messages with rich context information</p></li>
<li><p>create error messages when reading a TOML data structure</p></li>
<li><p>control the details captured in the context describing the TOML document</p></li>
<li><p>check a TOML document based on the token information in the context</p></li>
</ul>
</div>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="namelist-to-toml.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Converting from Namelist to TOML</p>
      </div>
    </a>
    <a class="right-next"
       href="json.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Writing a custom lexer</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#target-selection">Target selection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-of-the-linter">Configuration of the linter</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-package-name">Recommended package name</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bare-key-paths-preferred">Bare key paths preferred</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sebastian Ehlert
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2019-2025, Sebastian Ehlert.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>