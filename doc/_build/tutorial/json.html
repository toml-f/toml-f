

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Writing a custom lexer &#8212; TOML Fortran</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial/json';</script>
    <link rel="icon" href="../_static/toml-f.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="How-to guides" href="../how-to/index.html" />
    <link rel="prev" title="Building a linter" href="fpm-lint.html" /> 
<meta
  name="description"
  content="TOML parser implementation for data serialization and deserialization in Fortran"
/>
<meta
  name="keywords"
  content="TOML parser, TOML, serde, Fortran library, Fortran package manager"
/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/toml-f.svg" class="logo__image only-light" alt="TOML Fortran - Home"/>
    <img src="../_static/toml-f.svg" class="logo__image only-dark pst-js-only" alt="TOML Fortran - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Tutorials</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="fpm-lint.html">Building a linter</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Writing a custom lexer</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../how-to/index.html">How-Tos</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../how-to/installation.html">Installing TOML Fortran</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/integration.html">Using TOML Fortran</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/table.html">Working with tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/array.html">Working with arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/error.html">Reporting errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/datetime.html">Date time compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/serde.html">Serializable base class</a></li>
<li class="toctree-l2"><a class="reference internal" href="../how-to/jonquil.html">Compatibility with JSON</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">References</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://toml.io/en/v1.0.0">TOML specification</a></li>
<li class="toctree-l2"><a class="reference external" href="https://toml-f.github.io/toml-f">API documentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../external.html">External resources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://cyber.dabamos.de/programming/modernfortran/toml.html">Modern Fortran by Philipp Engel (English)</a></li>
<li class="toctree-l2"><a class="reference external" href="https://fortran-fans.github.io/Fortran-in-Action/Using-Open-Source-Code/Project-Configuration-TOML-F.html">Fortran in Action by Zuo Zhihua (Chinese)</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/toml-f/toml-f" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/toml-f/toml-f/edit/main/doc/tutorial/json.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Writing a custom lexer</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-limitation">Identifying limitation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-lexer">Creating the lexer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-tokens">Identifying tokens</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-values">Extracting values</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-the-lexer">Verifying the lexer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connecting-to-the-parser">Connecting to the parser</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section id="writing-a-custom-lexer">
<span id="json-lexer"></span><h1>Writing a custom lexer<a class="headerlink" href="#writing-a-custom-lexer" title="Permalink to this heading">#</a></h1>
<img alt="Difficulty: Intermediate" src="https://img.shields.io/badge/difficulty-intermediate-yellow" />
<p>Many programs already come with their input formats, switching to a different format requires establishing some way to get backward compatibility for older inputs.
When transitioning to TOML Fortran reading of the input will use the provided TOML data structures.
If the previous input format is sufficiently compatible, it can be parsed into a matching TOML data structure and allow to seamlessly use of the TOML format going forward while still providing compatibility for previously written inputs.</p>
<p>This tutorial is meant to teach how lexing in TOML Fortran works and enable the reader to implement their custom lexer for their custom format.
There is no guarantee that a custom input format can be ported by creating a custom lexer, since the format needs to fulfill some basic requirements, like providing typed values.
For this tutorial, we will choose <a class="reference external" href="https://json.org/">JSON</a> as our input format and walk through all the steps to create a new lexer from scratch.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The choice of JSON for this tutorial is not a coincidence.
TOML Fortran does implement this lexer to parse JSON files into TOML data structures to support the encoding tests in the validation suite of <a class="reference external" href="https://github.com/BurntSushi/toml-test/tree/v1.1.0#implementing-an-encoder">BurntSushi/toml-test</a>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This tutorial makes partial use of the internal API of TOML Fortran.</p>
</div>
<section id="identifying-limitation">
<h2>Identifying limitation<a class="headerlink" href="#identifying-limitation" title="Permalink to this heading">#</a></h2>
<p>Before we start to implement our custom lexer, we need to identify any limitations of the TOML data structures to represent our custom format.
TOML documents always have a table at the document root, there is no way to represent a JSON array or single value in TOML.
Furthermore, JSON supports the value type <code class="docutils literal notranslate"><span class="pre">null</span></code>, which is not representable in TOML.
We have two choices here, either we can flag <code class="docutils literal notranslate"><span class="pre">null</span></code> values as an invalid token or we can replace them in the lexer with something else like an empty table.
Finally, there are other details we have to take into account, like how JSON is handling duplicate keys, for most of the implementation-dependent cases we will follow the rules TOML provides.</p>
<p>This tutorial by no means aims for offering a fully compliant parser as we already fail for top-level arrays or <code class="docutils literal notranslate"><span class="pre">null</span></code> type values.
For a custom format, this might be even more challenging, especially if the format is defined by only a single implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Writing a compliant JSON parser can quickly become quite challenging (see <a class="reference external" href="https://seriot.ch/projects/parsing_json.html">Parsing JSON is a Minefield</a>).</p>
</div>
<p>But format limitations can go both ways, there are of course also features in TOML we cannot express in JSON.
However, since we want to map JSON to TOML and not the other way round we do not have to worry about limitations present in JSON.
Every feature available in TOML representable in the previous input format will be an incentive to switch to the new format.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For the actual application of the JSON parser in the validation suite, this problem is solved by not using only strings to represent values and adding type annotations.
In TOML Fortran these annotations are mapped back by pruning the read JSON data structure.
The pruning is done via a visitor which is accepted after the data structure has been completely parsed.</p>
</div>
</section>
<section id="creating-the-lexer">
<h2>Creating the lexer<a class="headerlink" href="#creating-the-lexer" title="Permalink to this heading">#</a></h2>
<p>First, we start by creating a new subclass of the abstract base class (ABC) imported from the <em>tomlf_de_abc</em> module.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (json_lexer)</span><a class="headerlink" href="#id1" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">use </span><span class="n">tomlf_constants</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="n">tfi</span><span class="p">,</span><span class="w"> </span><span class="n">tfr</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_datetime</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_datetime</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_abc</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">abstract_lexer</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_token</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_token</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">make_error</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_utils</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">read_whole_file</span><span class="p">,</span><span class="w"> </span><span class="n">read_whole_line</span>
<span class="w">   </span><span class="k">implicit none</span>
<span class="k">   private</span>

<span class="k">   public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_lexer</span>
<span class="w">   </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">new_lexer_from_file</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_unit</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_string</span>

<span class="w">   </span><span class="c">!&gt; Tokenizer for JSON documents</span>
<span class="w">   </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">abstract_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_lexer</span>
<span class="w">      </span><span class="c">!&gt; Name of the source file, used for error reporting</span>
<span class="w">      </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">      </span><span class="c">!&gt; Current internal position in the source chunk</span>
<span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c">!&gt; Current source chunk</span>
<span class="w">      </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">chunk</span>
<span class="w">      </span><span class="c">!&gt; Additional tokens to insert before the actual token stream</span>
<span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="k">contains</span>
<span class="w">      </span><span class="c">!&gt; Obtain the next token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">next</span>
<span class="w">      </span><span class="c">!&gt; Extract a string from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_string</span>
<span class="w">      </span><span class="c">!&gt; Extract an integer from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_integer</span>
<span class="w">      </span><span class="c">!&gt; Extract a float from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_float</span>
<span class="w">      </span><span class="c">!&gt; Extract a boolean from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_bool</span>
<span class="w">      </span><span class="c">!&gt; Extract a timestamp from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_datetime</span>
<span class="w">      </span><span class="c">!&gt; Get information about source</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">get_info</span>
<span class="w">   </span><span class="k">end type </span><span class="n">json_lexer</span>
</pre></div>
</div>
</div>
<p>We start by creating a constructor to consume an input file and turn it into a string to advance through.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (new_lexer_from_file)</span><a class="headerlink" href="#id2" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Create a new instance of a lexer by reading from a file</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_file</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Name of the file to read from</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="c">!&gt; Error code</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="k">call </span><span class="n">read_whole_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Could not open file &#39;&quot;</span><span class="o">//</span><span class="n">filename</span><span class="o">//</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_file</span>
</pre></div>
</div>
</div>
<p>Using a formatted unit is more inefficient compared to reading the whole file with direct access, but needed in case we are dealing with the standard input.
We make sure to error out if we get direct access or stream access units since we cannot reliably read those.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (new_lexer_from_unit)</span><a class="headerlink" href="#id3" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Create a new instance of a lexer by reading from a unit.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; Currently, only sequential access units can be processed by this constructor.</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_unit</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Unit to read from</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">io</span>
<span class="w">   </span><span class="c">!&gt; Error code</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">line</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bufsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="k">inquire</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="nb">access</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
<span class="w">   </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;SEQUENTIAL&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="kt">character</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
<span class="w">      </span><span class="k">do </span>
<span class="k">         call </span><span class="n">read_whole_line</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="k">         </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="nb">is_iostat_end</span><span class="p">(</span><span class="nb">stat</span><span class="p">))</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">exit</span>
<span class="k">         end if</span>
<span class="k">      end do</span>
<span class="k">      call </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="nb">len_trim</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Failed to read from unit&quot;</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_unit</span>
</pre></div>
</div>
</div>
<p>Finally, we sometimes also need to read from a string, there we add a constructor which can create a lexer for a string input.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (new_lexer_from_string)</span><a class="headerlink" href="#id4" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Create a new instance of a lexer by reading from a string.</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; String to read from</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>

<span class="w">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_string</span>
</pre></div>
</div>
</div>
<p>The parser might need access to some of the internal data of the lexer, which is done via the <em>get_info</em> procedure.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (get_info)</span><a class="headerlink" href="#id5" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract information about the source</span>
<span class="k">subroutine </span><span class="n">get_info</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Query about the source</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">meta</span>
<span class="w">   </span><span class="c">!&gt; Metadata about the source</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">output</span>

<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">end subroutine </span><span class="n">get_info</span>
</pre></div>
</div>
</div>
</section>
<section id="identifying-tokens">
<h2>Identifying tokens<a class="headerlink" href="#identifying-tokens" title="Permalink to this heading">#</a></h2>
<p>Now that we can instantiate the lexer we need to implement the possibility to recognize tokens, this is done with the <em>next</em> method.
We start with creating the actual tokenization step in the <em>next_token</em> procedure, which we will call in the <em>next</em> method.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_token)</span><a class="headerlink" href="#id6" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Actually generate the next token, unbuffered version</span>
<span class="k">subroutine </span><span class="n">next_token</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
</pre></div>
</div>
</div>
<p>As a first action, we will advance the internal state of the lexer by consuming the last token.
For convenience, we save the position in the source string in the <em>pos</em> and <em>prev</em> variables.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_token, continued)</span><a class="headerlink" href="#id7" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span>

<span class="w">   </span><span class="c">! Consume current token</span>
<span class="w">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
</pre></div>
</div>
</div>
<p>The next thing we check is if we have exhausted the input string and if so we return the <em>end of file</em> token.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_token, continued)</span><a class="headerlink" href="#id8" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="c">! If lexer is exhausted, return EOF as early as possible</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end if</span>
</pre></div>
</div>
</div>
<p>Now we can inspect the current character from the source string and decide which token it should be labeled.
The character set is quite simple, we have to consider opening and closing brackets and braces, for arrays and tables, respectively, commas, colons, strings, and whitespace.
We will be explicitly producing whitespace tokens here rather than skipping it since the parser can gracefully handle whitespace.
However, we have to consider that newlines have semantical meaning in TOML while they are only considered whitespace in JSON and therefore we will only produce whitespace tokens.</p>
<p>We use a select case statement to decide which token to produce.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_token, continued)</span><a class="headerlink" href="#id9" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">))</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span><span class="p">)</span>
<span class="w">      </span><span class="k">do while</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span><span class="p">])</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">whitespace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">equal</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbrace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbrace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbracket</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbracket</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">:</span><span class="s2">&quot;9&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_number</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_boolean</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_null</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end select</span>

<span class="w">   </span><span class="c">! If the current token is invalid, advance to the next terminator</span>
<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>
<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_token</span>
</pre></div>
</div>
</div>
<p>To wrap up the lexing we will try to identify unknown tokens as well as possible trying to advance to the next terminating character.
For the terminating characters, we choose whitespace as well as control characters and place those in the module scope.</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (terminated)</span><a class="headerlink" href="#id10" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; {}[],:&quot;</span><span class="o">//</span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="o">//</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="o">//</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are cheating a bit here since we declare the colon as an <em>equal</em> token.
This way we can use the same lexer for both JSON and TOML and still have the same parsing rules.</p>
</div>
<p>One special case to consider is literals, like strings numbers or booleans.
To not clutter the logic here we create separate routines for parsing the respective literal values.
For obtaining string values we will implement this as <em>next_string</em>.
Here we cannot simply advance to the next quote character, since we need to handle escape characters gracefully.
While doing so we can also ensure that the escape sequences found are valid and not malformed.</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_string)</span><a class="headerlink" href="#id11" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Process next string token</span>
<span class="k">subroutine </span><span class="n">next_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid_escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;btnfr\&quot;&#39;</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">escape</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">   </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">valid_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">verify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">valid_escape</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>
<span class="k">      </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="k">exit</span>
<span class="k">      end if</span>
<span class="k">   end do</span>

<span class="k">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">prev</span>
<span class="w">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="p">),</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_string</span>
</pre></div>
</div>
</div>
<p>Strings can only contain printable characters, therefore we check for valid string characters using a small <em>valid_string</em> function for each character.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (valid_string)</span><a class="headerlink" href="#id12" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Validate characters in string, non-printable characters are invalid in this context</span>
<span class="k">pure function </span><span class="n">valid_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;00&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x08</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;08&quot;</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">x0b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;0b&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x1f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;1f&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x7f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;7f&quot;</span><span class="p">))</span>

<span class="w">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.(</span><span class="n">x00</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">x08</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.(</span><span class="n">x0b</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">x1f</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">x7f</span>
<span class="k">end function </span><span class="n">valid_string</span>
</pre></div>
</div>
</div>
<p>We also need to identify numbers, mapping to either integers or floats in TOML, which is done via <em>next_number</em>.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_number)</span><a class="headerlink" href="#id13" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Process next number token, can produce either integer or floats</span>
<span class="k">subroutine </span><span class="n">next_number</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">expo</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">minus</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">first</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">offset</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>

<span class="w">   </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">expo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">   </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">   </span><span class="n">minus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minus</span><span class="p">)</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">expo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;e&quot;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;E&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">expo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">expo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;+&quot;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">any</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;E&quot;</span><span class="p">]))</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0123456789&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">         </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      exit</span>
<span class="k">   end do</span>

<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">expo</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="nb">any</span><span class="p">([</span><span class="n">expo</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_number</span>
</pre></div>
</div>
</div>
<p>To support boolean values we implement a <em>next_boolean</em> procedure.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_boolean)</span><a class="headerlink" href="#id14" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Process next boolean token</span>
<span class="k">subroutine </span><span class="n">next_boolean</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   select case</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">prev</span><span class="p">:</span><span class="n">pos</span><span class="p">))</span>
<span class="w">   </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">end subroutine </span><span class="n">next_boolean</span>
</pre></div>
</div>
</div>
<p>Finally, we also want to parse null values using the <em>next_null</em> procedure.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next_null)</span><a class="headerlink" href="#id15" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Process next null token</span>
<span class="k">subroutine </span><span class="n">next_null</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">nil</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">prev</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_null</span>
</pre></div>
</div>
</div>
<p>With this logic available we can now generate all required tokens for parsing JSON.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Moving most of the validation logic in the tokenization simplifies the actual extraction of the value as we have to deal with fewer edge cases.</p>
</div>
<p>Now we can wrap up the <em>next</em> procedure, instead of directly returning the token we will make some adjustments to the token stream here.
In general, this is the right place to buffer tokens, perform overflow checks, or detect unclosed groups, we will only use it to insert two additional tokens to inject a top-level key.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (next)</span><a class="headerlink" href="#id16" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Advance to the next token in the lexer</span>
<span class="k">subroutine </span><span class="n">next</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prelude</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">[</span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">equal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)]</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prelude</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="p">)</span>
<span class="w">      </span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end if</span>

<span class="k">   call </span><span class="n">next_token</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next</span>
</pre></div>
</div>
</div>
<p>This will direct the parser to leave the root document where newlines are semantically relevant since we cannot produce such newline tokens in our JSON lexer.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>The <em>nil</em> token will make the parser skip the respective value.
If we want to support <em>null</em> values, how would we have to modify our lexer to produce for example an empty table <code class="docutils literal notranslate"><span class="pre">{}</span></code> instead, <em>i.e.</em> a <em>lbrace</em> and <em>rbrace</em> token?</p>
</div>
</section>
<section id="extracting-values">
<h2>Extracting values<a class="headerlink" href="#extracting-values" title="Permalink to this heading">#</a></h2>
<p>Before we can connect our lexer to the existing TOML parser we have to implement the extraction of the values.
The parser itself will use the <em>extract</em> member functions to obtain values for the respective tokens and never directly access the character stream.</p>
<p>To extract the string value we implement the <em>extract_string</em> procedure.
We will also use the <em>extract_string</em> routine to catch the <em>keypath</em> token we inserted in the token stream and return the wanted dummy value.</p>
<div class="literal-block-wrapper docutils container" id="id17">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (extract_string)</span><a class="headerlink" href="#id17" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract string value of token</span>
<span class="k">subroutine </span><span class="n">extract_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract string value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; String value of token</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">length</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">escape</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>

<span class="w">   </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">)</span><span class="w">  </span><span class="c">! dummy token inserted by lexer prelude</span>
<span class="w">      </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;_&quot;</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">)</span>
<span class="w">      </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="k">do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">select case</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">dquote</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">ch</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">bspace</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">formfeed</span>
<span class="w">            </span><span class="k">end select</span>
<span class="k">            cycle</span>
<span class="k">         end if</span>
<span class="k">         </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">ch</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">   end select</span>
<span class="k">end subroutine </span><span class="n">extract_string</span>
</pre></div>
</div>
</div>
<p>Similarly, we implement the <em>extract_integer</em>, instead of using an internal read, we implement the reading ourselves.</p>
<div class="literal-block-wrapper docutils container" id="id18">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (extract_integer)</span><a class="headerlink" href="#id18" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract integer value of token</span>
<span class="k">subroutine </span><span class="n">extract_integer</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract integer value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Integer value of token</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">(</span><span class="n">tfi</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0123456789&quot;</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">first</span><span class="p">:</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">first</span><span class="p">:</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="p">)</span>
<span class="w">      </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">scan</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">      </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">val</span>
<span class="k">end subroutine </span><span class="n">extract_integer</span>
</pre></div>
</div>
</div>
<p>For floating point numbers implemented in <em>extract_float</em> we will just use an internal read.</p>
<div class="literal-block-wrapper docutils container" id="id19">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (extract_float)</span><a class="headerlink" href="#id19" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract floating point value of token</span>
<span class="k">subroutine </span><span class="n">extract_float</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ieee_arithmetic</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ieee_value</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">ieee_positive_inf</span><span class="p">,</span><span class="w"> </span><span class="n">ieee_negative_inf</span><span class="p">,</span><span class="w"> </span><span class="n">ieee_quiet_nan</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract floating point value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Floating point value of token</span>
<span class="w">   </span><span class="kt">real</span><span class="p">(</span><span class="n">tfr</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   read</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span><span class="w"> </span><span class="n">val</span>
<span class="k">end subroutine </span><span class="n">extract_float</span>
</pre></div>
</div>
</div>
<p>The last token we can produce and extract from our lexer is are boolean values, which we implement in <em>extract_boolean</em>.</p>
<div class="literal-block-wrapper docutils container" id="id20">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (extract_boolean)</span><a class="headerlink" href="#id20" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract boolean value of token</span>
<span class="k">subroutine </span><span class="n">extract_bool</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract boolean value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Boolean value of token</span>
<span class="w">   </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="k">end subroutine </span><span class="n">extract_bool</span>
</pre></div>
</div>
</div>
<p>We create a mocked routine for <em>extract_datetime</em> since we cannot produce this token in JSON.</p>
<div class="literal-block-wrapper docutils container" id="id21">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90 (extract_datetime)</span><a class="headerlink" href="#id21" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Extract datetime value of token</span>
<span class="k">subroutine </span><span class="n">extract_datetime</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract datetime value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Datetime value of token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_datetime</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="k">associate</span><span class="p">(</span><span class="n">lexer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w">  </span><span class="c">! ignore unused dummy arguments</span>
<span class="w">   </span><span class="k">end associate</span>
<span class="k">end subroutine </span><span class="n">extract_datetime</span>
</pre></div>
</div>
</div>
<p>This provides our lexer with full functionality regarding the extraction of values needed for parsing and creating data structures.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">full source</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">For completeness here is again the full source of our lexer implementation.</p>
<div class="literal-block-wrapper docutils container" id="id22">
<div class="code-block-caption"><span class="caption-text">src/json_lexer.f90</span><a class="headerlink" href="#id22" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">tjson_lexer</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_constants</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="n">tfi</span><span class="p">,</span><span class="w"> </span><span class="n">tfr</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_datetime</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_datetime</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_abc</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">abstract_lexer</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_token</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_token</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_error</span><span class="p">,</span><span class="w"> </span><span class="n">make_error</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_utils</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">read_whole_file</span><span class="p">,</span><span class="w"> </span><span class="n">read_whole_line</span>
<span class="w">   </span><span class="k">implicit none</span>
<span class="k">   private</span>

<span class="k">   public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_lexer</span>
<span class="w">   </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">new_lexer_from_file</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_unit</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_string</span>
<span class="w">   </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">toml_token</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span>

<span class="w">   </span><span class="c">!&gt; Tokenizer for JSON documents</span>
<span class="w">   </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">abstract_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_lexer</span>
<span class="w">      </span><span class="c">!&gt; Name of the source file, used for error reporting</span>
<span class="w">      </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">      </span><span class="c">!&gt; Current internal position in the source chunk</span>
<span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">      </span><span class="c">!&gt; Current source chunk</span>
<span class="w">      </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">chunk</span>
<span class="w">      </span><span class="c">!&gt; Additional tokens to insert before the actual token stream</span>
<span class="w">      </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>
<span class="w">   </span><span class="k">contains</span>
<span class="w">      </span><span class="c">!&gt; Obtain the next token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">next</span>
<span class="w">      </span><span class="c">!&gt; Extract a string from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_string</span>
<span class="w">      </span><span class="c">!&gt; Extract an integer from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_integer</span>
<span class="w">      </span><span class="c">!&gt; Extract a float from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_float</span>
<span class="w">      </span><span class="c">!&gt; Extract a boolean from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_bool</span>
<span class="w">      </span><span class="c">!&gt; Extract a timestamp from a token</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">extract_datetime</span>
<span class="w">      </span><span class="c">!&gt; Get information about source</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">get_info</span>
<span class="w">   </span><span class="k">end type </span><span class="n">json_lexer</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">terminated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; {}[],:&quot;</span><span class="o">//</span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="o">//</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="o">//</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span>

<span class="k">contains</span>

<span class="c">!&gt; Create a new instance of a lexer by reading from a file</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_file</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Name of the file to read from</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="c">!&gt; Error code</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="k">call </span><span class="n">read_whole_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Could not open file &#39;&quot;</span><span class="o">//</span><span class="n">filename</span><span class="o">//</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_file</span>

<span class="c">!&gt; Create a new instance of a lexer by reading from a unit.</span>
<span class="c">!&gt;</span>
<span class="c">!&gt; Currently, only sequential access units can be processed by this constructor.</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_unit</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Unit to read from</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">io</span>
<span class="w">   </span><span class="c">!&gt; Error code</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">line</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">bufsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">512</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="k">inquire</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="nb">access</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>
<span class="w">   </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;sequential&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;SEQUENTIAL&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">allocate</span><span class="p">(</span><span class="kt">character</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
<span class="w">      </span><span class="k">do </span>
<span class="k">         call </span><span class="n">read_whole_line</span><span class="p">(</span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">line</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="k">         </span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="nb">is_iostat_end</span><span class="p">(</span><span class="nb">stat</span><span class="p">))</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="k">exit</span>
<span class="k">         end if</span>
<span class="k">      end do</span>
<span class="k">      call </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="nb">len_trim</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">call </span><span class="n">make_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Failed to read from unit&quot;</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_unit</span>

<span class="c">!&gt; Create a new instance of a lexer by reading from a string.</span>
<span class="k">subroutine </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; String to read from</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>

<span class="w">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span>
<span class="k">end subroutine </span><span class="n">new_lexer_from_string</span>

<span class="c">!&gt; Extract information about the source</span>
<span class="k">subroutine </span><span class="n">get_info</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">output</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Query about the source</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">meta</span>
<span class="w">   </span><span class="c">!&gt; Metadata about the source</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">output</span>

<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span><span class="p">))</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">filename</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">end subroutine </span><span class="n">get_info</span>

<span class="c">!&gt; Advance to the next token in the lexer</span>
<span class="k">subroutine </span><span class="n">next</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prelude</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">[</span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">equal</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)]</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prelude</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="p">)</span>
<span class="w">      </span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end if</span>

<span class="k">   call </span><span class="n">next_token</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next</span>

<span class="c">!&gt; Actually generate the next token, unbuffered version</span>
<span class="k">subroutine </span><span class="n">next_token</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span>

<span class="w">   </span><span class="c">! Consume current token</span>
<span class="w">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="c">! If lexer is exhausted, return EOF as early as possible</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end if</span>

<span class="k">   select case</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">))</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span><span class="p">)</span>
<span class="w">      </span><span class="k">do while</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span><span class="p">])</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">whitespace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">equal</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;{&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbrace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;}&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbrace</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">lbracket</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">rbracket</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">:</span><span class="s2">&quot;9&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_number</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;f&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_boolean</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">next_null</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   case</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">   end select</span>

<span class="w">   </span><span class="c">! If the current token is invalid, advance to the next terminator</span>
<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>
<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_token</span>

<span class="c">!&gt; Process next string token</span>
<span class="k">subroutine </span><span class="n">next_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid_escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;btnfr\&quot;&#39;</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">escape</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">   </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">valid_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="nb">verify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="n">valid_escape</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>
<span class="k">      </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">exit</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="k">exit</span>
<span class="k">      end if</span>
<span class="k">   end do</span>

<span class="k">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">valid</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;&quot;&#39;</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">prev</span>
<span class="w">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">valid</span><span class="p">),</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_string</span>

<span class="c">!&gt; Process next number token, can produce either integer or floats</span>
<span class="k">subroutine </span><span class="n">next_number</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">,</span><span class="w"> </span><span class="n">expo</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">minus</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">first</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">offset</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">]</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>

<span class="w">   </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">expo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">   </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">   </span><span class="n">minus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">minus</span><span class="p">)</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;.&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">point</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">expo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">point</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;e&quot;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;E&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">expo</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">expo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;+&quot;</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">any</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;E&quot;</span><span class="p">]))</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0123456789&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="n">zero</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>
<span class="k">         </span><span class="n">zero</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;0&quot;</span>
<span class="w">         </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">         </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="k">cycle</span>
<span class="k">      end if</span>

<span class="k">      exit</span>
<span class="k">   end do</span>

<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="nb">any</span><span class="p">([</span><span class="n">expo</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="nb">any</span><span class="p">([</span><span class="n">expo</span><span class="p">,</span><span class="w"> </span><span class="n">point</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_number</span>

<span class="c">!&gt; Process next boolean token</span>
<span class="k">subroutine </span><span class="n">next_boolean</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   select case</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">prev</span><span class="p">:</span><span class="n">pos</span><span class="p">))</span>
<span class="w">   </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">end subroutine </span><span class="n">next_boolean</span>

<span class="c">!&gt; Process next null token</span>
<span class="k">subroutine </span><span class="n">next_null</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Current token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pos</span><span class="p">,</span><span class="w"> </span><span class="n">prev</span>

<span class="w">   </span><span class="n">prev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>
<span class="w">   </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">pos</span>

<span class="w">   </span><span class="k">do while</span><span class="p">(</span><span class="nb">verify</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="n">terminated</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">))</span>
<span class="w">      </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_token</span><span class="p">(</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="nb">merge</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">nil</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">prev</span><span class="p">:</span><span class="n">pos</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;null&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">prev</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">next_null</span>

<span class="c">!&gt; Validate characters in string, non-printable characters are invalid in this context</span>
<span class="k">pure function </span><span class="n">valid_string</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid</span>

<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">x00</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;00&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x08</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;08&quot;</span><span class="p">)),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">x0b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;0b&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x1f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;1f&quot;</span><span class="p">)),</span><span class="w"> </span><span class="n">x7f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="s2">&quot;7f&quot;</span><span class="p">))</span>

<span class="w">   </span><span class="n">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.(</span><span class="n">x00</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">x08</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.(</span><span class="n">x0b</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">x1f</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">x7f</span>
<span class="k">end function </span><span class="n">valid_string</span>

<span class="c">!&gt; Extract string value of token</span>
<span class="k">subroutine </span><span class="n">extract_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract string value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; String value of token</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">length</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">escape</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>

<span class="w">   </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">   </span><span class="k">select case</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="p">)</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">keypath</span><span class="p">)</span><span class="w">  </span><span class="c">! dummy token inserted by lexer prelude</span>
<span class="w">      </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;_&quot;</span>
<span class="w">   </span><span class="k">case</span><span class="p">(</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">)</span>
<span class="w">      </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;&quot;</span>
<span class="w">      </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">      </span><span class="k">do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">         </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">select case</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="n">toml_escape</span><span class="p">%</span><span class="n">dquote</span><span class="p">,</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">ch</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">bspace</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">tabulator</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">newline</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">carriage_return</span>
<span class="w">            </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">);</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">formfeed</span>
<span class="w">            </span><span class="k">end select</span>
<span class="k">            cycle</span>
<span class="k">         end if</span>
<span class="k">         </span><span class="n">escape</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_escape</span><span class="p">%</span><span class="n">backslash</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">escape</span><span class="p">)</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="n">ch</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">   end select</span>
<span class="k">end subroutine </span><span class="n">extract_string</span>

<span class="c">!&gt; Extract integer value of token</span>
<span class="k">subroutine </span><span class="n">extract_integer</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract integer value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Integer value of token</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">(</span><span class="n">tfi</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ch</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0123456789&quot;</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">   </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">first</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">first</span><span class="p">:</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">first</span><span class="p">:</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span>
<span class="w">      </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">it</span><span class="p">:</span><span class="n">it</span><span class="p">)</span>
<span class="w">      </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">scan</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">      </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">   </span><span class="k">end do</span>

<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">)</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">val</span>
<span class="k">end subroutine </span><span class="n">extract_integer</span>

<span class="c">!&gt; Extract floating point value of token</span>
<span class="k">subroutine </span><span class="n">extract_float</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ieee_arithmetic</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">ieee_value</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">ieee_positive_inf</span><span class="p">,</span><span class="w"> </span><span class="n">ieee_negative_inf</span><span class="p">,</span><span class="w"> </span><span class="n">ieee_quiet_nan</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract floating point value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Floating point value of token</span>
<span class="w">   </span><span class="kt">real</span><span class="p">(</span><span class="n">tfr</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   read</span><span class="p">(</span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">),</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span><span class="w"> </span><span class="n">val</span>
<span class="k">end subroutine </span><span class="n">extract_float</span>

<span class="c">!&gt; Extract boolean value of token</span>
<span class="k">subroutine </span><span class="n">extract_bool</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract boolean value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Boolean value of token</span>
<span class="w">   </span><span class="kt">logical</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">bool</span><span class="p">)</span><span class="w"> </span><span class="k">return</span>

<span class="k">   </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lexer</span><span class="p">%</span><span class="n">chunk</span><span class="p">(</span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">:</span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;true&quot;</span>
<span class="k">end subroutine </span><span class="n">extract_bool</span>

<span class="c">!&gt; Extract datetime value of token</span>
<span class="k">subroutine </span><span class="n">extract_datetime</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the lexer</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="c">!&gt; Token to extract datetime value from</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="c">!&gt; Datetime value of token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_datetime</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="k">associate</span><span class="p">(</span><span class="n">lexer</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">token</span><span class="p">)</span><span class="w">  </span><span class="c">! ignore unused dummy arguments</span>
<span class="w">   </span><span class="k">end associate</span>
<span class="k">end subroutine </span><span class="n">extract_datetime</span>

<span class="k">end module </span><span class="n">tjson_lexer</span>
</pre></div>
</div>
</div>
</div>
</details></section>
<section id="verifying-the-lexer">
<h2>Verifying the lexer<a class="headerlink" href="#verifying-the-lexer" title="Permalink to this heading">#</a></h2>
<p>We could start right into connecting our lexer with the parser, but we have not yet verified that the tokenization and value extraction work as expected.
For this purpose, we will create some unit tests using the <a class="reference external" href="https://github.com/fortran-lang/test-drive">test-drive</a> framework.</p>
<p>As the entry point for our tester, we will use the standard wrapper for launching test suites.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">tester program</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">Taken from the <a class="reference external" href="https://github.com/fortran-lang/test-drive">test-drive</a> README</p>
<div class="literal-block-wrapper docutils container" id="id23">
<div class="code-block-caption"><span class="caption-text">test/main.f90</span><a class="headerlink" href="#id23" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Wrapper for the testsuites</span>
<span class="k">program </span><span class="n">tester</span>
<span class="w">   </span><span class="k">use</span><span class="p">,</span><span class="w"> </span><span class="k">intrinsic</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">iso_fortran_env</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">error_unit</span>
<span class="w">   </span><span class="k">use </span><span class="n">testdrive</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">run_testsuite</span><span class="p">,</span><span class="w"> </span><span class="n">new_testsuite</span><span class="p">,</span><span class="w"> </span><span class="n">testsuite_type</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">select_suite</span><span class="p">,</span><span class="w"> </span><span class="n">run_selected</span><span class="p">,</span><span class="w"> </span><span class="n">get_argument</span>
<span class="w">   </span><span class="k">use </span><span class="n">test_lexer</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">collect_lexer</span>
<span class="w">   </span><span class="k">implicit none</span>
<span class="k">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span><span class="p">,</span><span class="w"> </span><span class="k">is</span>
<span class="k">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">suite_name</span><span class="p">,</span><span class="w"> </span><span class="n">test_name</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">testsuite_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">testsuites</span><span class="p">(:)</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fmt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;(&quot;#&quot;, *(1x, a))&#39;</span>

<span class="w">   </span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">   </span><span class="n">testsuites</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_testsuite</span><span class="p">(</span><span class="s2">&quot;lexer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collect_lexer</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">]</span>

<span class="w">   </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">suite_name</span><span class="p">)</span>
<span class="w">   </span><span class="k">call </span><span class="n">get_argument</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">test_name</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">suite_name</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      is</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">select_suite</span><span class="p">(</span><span class="n">testsuites</span><span class="p">,</span><span class="w"> </span><span class="n">suite_name</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">is</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">testsuites</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">         if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">test_name</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Suite:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">name</span>
<span class="w">            </span><span class="k">call </span><span class="n">run_selected</span><span class="p">(</span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">collect</span><span class="p">,</span><span class="w"> </span><span class="n">test_name</span><span class="p">,</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">               error stop </span><span class="mi">1</span>
<span class="w">            </span><span class="k">end if</span>
<span class="k">         else</span>
<span class="k">            write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Testing:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">name</span>
<span class="w">            </span><span class="k">call </span><span class="n">run_testsuite</span><span class="p">(</span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">collect</span><span class="p">,</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">         </span><span class="k">end if</span>
<span class="k">      else</span>
<span class="k">         write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Available testsuites&quot;</span>
<span class="w">         </span><span class="k">do is</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">testsuites</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;-&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">name</span>
<span class="w">         </span><span class="k">end do</span>
<span class="k">         error stop </span><span class="mi">1</span>
<span class="w">      </span><span class="k">end if</span>
<span class="k">   else</span>
<span class="k">      do is</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">testsuites</span><span class="p">)</span>
<span class="w">         </span><span class="k">write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="n">fmt</span><span class="p">)</span><span class="w"> </span><span class="s2">&quot;Testing:&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">name</span>
<span class="w">         </span><span class="k">call </span><span class="n">run_testsuite</span><span class="p">(</span><span class="n">testsuites</span><span class="p">(</span><span class="k">is</span><span class="p">)%</span><span class="n">collect</span><span class="p">,</span><span class="w"> </span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">      </span><span class="k">end do</span>
<span class="k">   end if</span>

<span class="k">   if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      write</span><span class="p">(</span><span class="n">error_unit</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(i0, 1x, a)&#39;</span><span class="p">)</span><span class="w"> </span><span class="nb">stat</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;test(s) failed!&quot;</span>
<span class="w">      </span><span class="k">error stop </span><span class="mi">1</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end program </span><span class="n">tester</span>
</pre></div>
</div>
</div>
</div>
</details><p>Our actual test suite for the lexer will be based on a routine called <em>check_token</em>, which creates a new lexer from a string and retrieves all tokens while comparing them with a reference token stream.
We then can implement our checks by providing a string and a list of tokens to see whether our lexer can identify the expected tokens correctly.
For visualization, we use the <em>tomlf_diagnostic</em> module to label the tokens in the actual source string.</p>
<div class="literal-block-wrapper docutils container" id="id24">
<div class="code-block-caption"><span class="caption-text">test/test_lexer.f90</span><a class="headerlink" href="#id24" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">test_lexer</span>
<span class="w">   </span><span class="k">use </span><span class="n">testdrive</span>
<span class="w">   </span><span class="k">use </span><span class="n">tjson_lexer</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_constants</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tfi</span><span class="p">,</span><span class="w"> </span><span class="n">tfr</span><span class="p">,</span><span class="w"> </span><span class="n">nl</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">TOML_NEWLINE</span>
<span class="w">   </span><span class="k">implicit none</span>

<span class="k">   public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">collect_lexer</span>

<span class="k">contains</span>

<span class="c">!&gt; Collect all exported unit tests</span>
<span class="k">subroutine </span><span class="n">collect_lexer</span><span class="p">(</span><span class="n">testsuite</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Collection of tests</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">unittest_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">testsuite</span><span class="p">(:)</span>

<span class="w">   </span><span class="n">testsuite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;bool-true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bool_true</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;bool-falsey&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bool_falsey</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">empty</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;float-point&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">float_point</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;float-double-point&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">float_double_point</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;integer-limits&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">integer_limits</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_unittest</span><span class="p">(</span><span class="s2">&quot;whitespace-mixed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">whitespace_mixed</span><span class="p">)]</span>

<span class="k">end subroutine </span><span class="n">collect_lexer</span>

<span class="k">subroutine </span><span class="n">empty</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">empty</span>

<span class="k">subroutine </span><span class="n">bool_falsey</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;falsey&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">bool_falsey</span>

<span class="k">subroutine </span><span class="n">bool_true</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">bool</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">bool_true</span>

<span class="k">subroutine </span><span class="n">float_point</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;3.14,+3.14,-3.14,0.123&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w">  </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">float</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">float_point</span>

<span class="k">subroutine </span><span class="n">float_double_point</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;0..1,0.1.2&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">invalid</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">float_double_point</span>

<span class="k">subroutine </span><span class="n">integer_limits</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;9223372036854775807,-9223372036854775808&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="nb">int</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">integer_limits</span>

<span class="k">subroutine </span><span class="n">string</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;&quot;&quot;something&quot;&quot;,&quot;&quot;anything&quot;&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">comma</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">string</span>

<span class="k">subroutine </span><span class="n">whitespace_mixed</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">call </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="nb">achar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">//</span><span class="s2">&quot; &quot;</span><span class="o">//</span><span class="nb">achar</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">token_kind</span><span class="p">%</span><span class="n">whitespace</span><span class="p">,</span><span class="w"> </span><span class="n">token_kind</span><span class="p">%</span><span class="n">eof</span><span class="p">])</span>
<span class="k">end subroutine </span><span class="n">whitespace_mixed</span>

<span class="k">subroutine </span><span class="n">check_token</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_diagnostic</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">render</span><span class="p">,</span><span class="w"> </span><span class="n">toml_label</span><span class="p">,</span><span class="w"> </span><span class="n">toml_level</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_token</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">stringify</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_terminal</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_terminal</span>
<span class="w">   </span><span class="c">!&gt; Error handling</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">   </span><span class="c">!&gt; String to be parsed</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>
<span class="w">   </span><span class="c">!&gt; Expected token kind</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">expected</span><span class="p">(:)</span>

<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">it</span>
<span class="w">   </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">okay</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">msg</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_token</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">token</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_label</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">label</span><span class="p">(:)</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="n">lexer</span><span class="p">%</span><span class="n">prelude</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>

<span class="w">   </span><span class="k">allocate</span><span class="p">(</span><span class="n">label</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="w">   </span><span class="k">do </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">lexer</span><span class="p">%</span><span class="n">next</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
<span class="w">      </span><span class="n">okay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<span class="w">      </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">toml_label</span><span class="p">(</span><span class="nb">merge</span><span class="p">(</span><span class="n">toml_level</span><span class="p">%</span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">toml_level</span><span class="p">%</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">okay</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="p">&amp;</span><span class="w">     </span><span class="n">token</span><span class="p">%</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="n">last</span><span class="p">,</span><span class="w"> </span><span class="n">stringify</span><span class="p">(</span><span class="n">token</span><span class="p">),</span><span class="w"> </span><span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">okay</span><span class="p">)]</span>
<span class="w">      </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">string</span><span class="o">//</span><span class="n">nl</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">label</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">label</span><span class="p">))],</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">(.</span><span class="n">true</span><span class="p">.))</span>
<span class="w">      </span><span class="k">call </span><span class="n">check</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="p">%</span><span class="nb">kind</span><span class="p">,</span><span class="w"> </span><span class="n">expected</span><span class="p">(</span><span class="n">it</span><span class="p">),</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;Expected &#39;&quot;</span><span class="o">//</span><span class="n">stringify</span><span class="p">(</span><span class="n">toml_token</span><span class="p">(</span><span class="n">expected</span><span class="p">(</span><span class="n">it</span><span class="p">)))</span><span class="o">//</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">         </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;&#39; but got &#39;&quot;</span><span class="o">//</span><span class="n">stringify</span><span class="p">(</span><span class="n">token</span><span class="p">)</span><span class="o">//</span><span class="s2">&quot;&#39;&quot;</span><span class="o">//</span><span class="n">nl</span><span class="o">//</span><span class="n">msg</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="k">   end do</span>
<span class="k">   if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">render</span><span class="p">(</span><span class="n">string</span><span class="o">//</span><span class="n">nl</span><span class="p">,</span><span class="w"> </span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">toml_terminal</span><span class="p">(.</span><span class="n">true</span><span class="p">.))</span>
<span class="w">      </span><span class="k">print</span><span class="w"> </span><span class="s1">&#39;(a)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end subroutine </span><span class="n">check_token</span>

<span class="k">end module </span><span class="n">test_lexer</span>
</pre></div>
</div>
</div>
<p>These are only a couple of tests, we have much more cases to consider for a robust lexer.</p>
<div class="admonition-exercise admonition">
<p class="admonition-title">Exercise</p>
<p>Write at least ten more tests for edge cases in the lexer.
Make sure to include invalid cases and ensure that even invalid tokens are generated correctly.</p>
</div>
</section>
<section id="connecting-to-the-parser">
<h2>Connecting to the parser<a class="headerlink" href="#connecting-to-the-parser" title="Permalink to this heading">#</a></h2>
<p>Now that we have verified the tokenization process in our lexer we can connect our custom lexer to the default TOML parser.</p>
<p>For this purpose we define convenience interfaces called <em>json_load</em> / <em>json_loads</em> similar to the available <em>toml_load</em> / <em>toml_loads</em> interfaces.
Other than the TOML-related load interfaces, we will also use them to implement necessary post-processing steps for the data structure.</p>
<div class="literal-block-wrapper docutils container" id="id25">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90</span><a class="headerlink" href="#id25" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">tjson_parser</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_constants</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="n">tfi</span><span class="p">,</span><span class="w"> </span><span class="n">tfr</span><span class="p">,</span><span class="w"> </span><span class="n">toml_type</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_datetime</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_datetime</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_context</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_context</span>
<span class="w">   </span><span class="k">use </span><span class="n">tjson_lexer</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">json_lexer</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_string</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_unit</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_lexer_from_file</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_parser</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">parse</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_diagnostic</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_level</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_build</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">get_value</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_error</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_type</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_value</span><span class="p">,</span><span class="w"> </span><span class="n">cast_to_table</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_visitor</span><span class="p">,</span><span class="w"> </span><span class="n">toml_array</span><span class="p">,</span><span class="w"> </span><span class="n">toml_keyval</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span>
<span class="nb">   </span><span class="k">implicit none</span>
<span class="k">   private</span>

<span class="k">   public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load</span><span class="p">,</span><span class="w"> </span><span class="n">json_loads</span>
<span class="w">   </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span><span class="p">,</span><span class="w"> </span><span class="n">toml_level</span>


<span class="w">   </span><span class="c">!&gt; Load a TOML data structure from the provided source</span>
<span class="w">   </span><span class="k">interface </span><span class="n">json_load</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_file</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_unit</span>
<span class="w">   </span><span class="k">end interface </span><span class="n">json_load</span>

<span class="w">   </span><span class="c">!&gt; Load a TOML data structure from a string</span>
<span class="w">   </span><span class="k">interface </span><span class="n">json_loads</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_string</span>
<span class="w">   </span><span class="k">end interface </span><span class="n">json_loads</span>
</pre></div>
</div>
</div>
<p>The <em>json_load</em> interface is implemented by <em>json_load_file</em> and <em>json_load_unit</em>.
The former is a wrapper that is using the <em>new_lexer_from_file</em> constructor.</p>
<div class="literal-block-wrapper docutils container" id="id26">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90 (json_load_file)</span><a class="headerlink" href="#id26" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Load TOML data structure from file</span>
<span class="k">subroutine </span><span class="n">json_load_file</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Name of the file to load</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_file</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">error_</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error_</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">error_</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end subroutine </span><span class="n">json_load_file</span>
</pre></div>
</div>
</div>
<p>The latter wraps the <em>new_lexer_from_unit</em> constructor.</p>
<div class="literal-block-wrapper docutils container" id="id27">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90 (json_load_unit)</span><a class="headerlink" href="#id27" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Load TOML data structure from unit</span>
<span class="k">subroutine </span><span class="n">json_load_unit</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Unit to read from</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">io</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_unit</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">error_</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error_</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">error_</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end subroutine </span><span class="n">json_load_unit</span>
</pre></div>
</div>
</div>
<p>Finally, we also provide <em>json_loads</em> by implementing <em>json_load_string</em> using our <em>new_lexer_from_string</em> constructor.</p>
<div class="literal-block-wrapper docutils container" id="id28">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90 (json_load_unit)</span><a class="headerlink" href="#id28" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Load TOML data structure from string</span>
<span class="k">subroutine </span><span class="n">json_load_string</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; String containing TOML document</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="k">call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">json_load_string</span>
</pre></div>
</div>
</div>
<p>These wrappers so far are very straightforward, first setting up a lexer instance and invoking the <em>parse</em> procedure which will construct the actual parser instance and process the token stream.
After a successful run, the <em>table</em> instance will be allocated, for the post-processing, we invoke the <em>prune</em> routine.</p>
<div class="literal-block-wrapper docutils container" id="id29">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90 (prune)</span><a class="headerlink" href="#id29" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">subroutine </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">prune</span>
</pre></div>
</div>
</div>
<p>Where we effectively remove the first child from the root table and return is a polymorphic <em>toml_value</em>.
This has the advantage that we can support arrays and values at the root level with our JSON loader.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The user can dispatch the value using a <em>select type</em> construct or by creating a view using the <em>cast_to_table</em> / <em>cast_to_array</em> / <em>cast_to_keyval</em> functions.</p>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">full source</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">For completeness here is again the full source of our parser implementation.</p>
<p class="sd-card-text">Note that this implementation also contains an implementation of a <em>toml_visitor</em> to prune type annotations used in the validation test suite to represent TOML values.</p>
<div class="literal-block-wrapper docutils container" id="id30">
<div class="code-block-caption"><span class="caption-text">src/json_parser.f90</span><a class="headerlink" href="#id30" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">tjson_parser</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_constants</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="n">tfi</span><span class="p">,</span><span class="w"> </span><span class="n">tfr</span><span class="p">,</span><span class="w"> </span><span class="n">toml_type</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_datetime</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_datetime</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_context</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_context</span>
<span class="w">   </span><span class="k">use </span><span class="n">tjson_lexer</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">json_lexer</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_string</span><span class="p">,</span><span class="w"> </span><span class="n">new_lexer_from_unit</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">new_lexer_from_file</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_de_parser</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">parse</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_diagnostic</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_level</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_build</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">get_value</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_error</span>
<span class="w">   </span><span class="k">use </span><span class="n">tomlf_type</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_value</span><span class="p">,</span><span class="w"> </span><span class="n">cast_to_table</span><span class="p">,</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">      </span><span class="p">&amp;</span><span class="w"> </span><span class="n">toml_visitor</span><span class="p">,</span><span class="w"> </span><span class="n">toml_array</span><span class="p">,</span><span class="w"> </span><span class="n">toml_keyval</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span>
<span class="nb">   </span><span class="k">implicit none</span>
<span class="k">   private</span>

<span class="k">   public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load</span><span class="p">,</span><span class="w"> </span><span class="n">json_loads</span>
<span class="w">   </span><span class="k">public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">toml_context</span><span class="p">,</span><span class="w"> </span><span class="n">toml_parser_config</span><span class="p">,</span><span class="w"> </span><span class="n">toml_level</span>


<span class="w">   </span><span class="c">!&gt; Load a TOML data structure from the provided source</span>
<span class="w">   </span><span class="k">interface </span><span class="n">json_load</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_file</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_unit</span>
<span class="w">   </span><span class="k">end interface </span><span class="n">json_load</span>

<span class="w">   </span><span class="c">!&gt; Load a TOML data structure from a string</span>
<span class="w">   </span><span class="k">interface </span><span class="n">json_loads</span>
<span class="w">      </span><span class="k">module procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_load_string</span>
<span class="w">   </span><span class="k">end interface </span><span class="n">json_loads</span>

<span class="w">   </span><span class="c">!&gt; Implement pruning of annotated values as visitor</span>
<span class="w">   </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">toml_visitor</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">json_prune</span>
<span class="w">   </span><span class="k">contains</span>
<span class="w">      </span><span class="c">!&gt; Traverse the AST and prune all annotated values</span>
<span class="w">      </span><span class="k">procedure</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">visit</span>
<span class="w">   </span><span class="k">end type </span><span class="n">json_prune</span>

<span class="k">contains</span>

<span class="c">!&gt; Load TOML data structure from file</span>
<span class="k">subroutine </span><span class="n">json_load_file</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Name of the file to load</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">filename</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_file</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">filename</span><span class="p">,</span><span class="w"> </span><span class="n">error_</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error_</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">error_</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end subroutine </span><span class="n">json_load_file</span>

<span class="c">!&gt; Load TOML data structure from unit</span>
<span class="k">subroutine </span><span class="n">json_load_unit</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Unit to read from</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">io</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_unit</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">io</span><span class="p">,</span><span class="w"> </span><span class="n">error_</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error_</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">error_</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">end if</span>
<span class="k">end subroutine </span><span class="n">json_load_unit</span>

<span class="c">!&gt; Load TOML data structure from string</span>
<span class="k">subroutine </span><span class="n">json_load_string</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; String containing TOML document</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">string</span>
<span class="w">   </span><span class="c">!&gt; Configuration for the parser</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_parser_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">   </span><span class="c">!&gt; Context tracking the origin of the data structure to allow rich reports</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_context</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">context</span>
<span class="w">   </span><span class="c">!&gt; Error handling, provides detailed diagnostic in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_error</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_lexer</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lexer</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">call </span><span class="n">new_lexer_from_string</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">)</span>
<span class="w">   </span><span class="k">call </span><span class="n">parse</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">json_load_string</span>

<span class="c">!&gt; Prune the artificial root table inserted by the lexer</span>
<span class="k">subroutine </span><span class="n">prune</span><span class="p">(</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">object</span>
<span class="w">   </span><span class="c">!&gt; Instance of the TOML data structure, not allocated in case of error</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">json_prune</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">pruner</span>

<span class="w">   </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">)</span>

<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">object</span><span class="p">))</span><span class="w"> </span><span class="k">call </span><span class="n">object</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">pruner</span><span class="p">)</span>
<span class="k">end subroutine </span><span class="n">prune</span>

<span class="c">!&gt; Visit a TOML value</span>
<span class="k">subroutine </span><span class="n">visit</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the JSON pruner</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_prune</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">self</span>
<span class="w">   </span><span class="c">!&gt; TOML value to visit</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>

<span class="w">   </span><span class="k">select type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">class is</span><span class="p">(</span><span class="n">toml_array</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">visit_array</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">class is</span><span class="p">(</span><span class="n">toml_table</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">visit_table</span><span class="p">(</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">end select</span>
<span class="k">end subroutine </span><span class="n">visit</span>

<span class="c">!&gt; Visit a TOML array</span>
<span class="k">subroutine </span><span class="n">visit_array</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the JSON pruner</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_prune</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">visitor</span>
<span class="w">   </span><span class="c">!&gt; TOML value to visit</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_array</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">array</span>

<span class="k">   class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">str</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">vt</span><span class="p">(:)</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="k">array</span><span class="p">)</span>
<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="w">      </span><span class="k">call array</span><span class="p">%</span><span class="n">shift</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="w">      </span><span class="k">select type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="w">      </span><span class="k">class </span><span class="n">default</span>
<span class="w">         </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">      </span><span class="k">class is</span><span class="p">(</span><span class="n">toml_table</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="n">get_keys</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="p">%</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">val</span><span class="p">%</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">get_value</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">prune_value</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="n">destroy</span>
<span class="w">            </span><span class="k">call </span><span class="n">tmp</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">            </span><span class="k">call array</span><span class="p">%</span><span class="n">push_back</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">            </span><span class="k">cycle</span>
<span class="k">         else</span>
<span class="k">            call </span><span class="n">val</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">         </span><span class="k">end if</span>
<span class="k">      end select</span>
<span class="k">      call array</span><span class="p">%</span><span class="n">push_back</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">   </span><span class="k">end do</span>
<span class="k">end subroutine </span><span class="n">visit_array</span>

<span class="c">!&gt; Visit a TOML table</span>
<span class="k">subroutine </span><span class="n">visit_table</span><span class="p">(</span><span class="n">visitor</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Instance of the JSON pruner</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">json_prune</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">visitor</span>
<span class="w">   </span><span class="c">!&gt; TOML table to visit</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ptr</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">str</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list</span><span class="p">(:),</span><span class="w"> </span><span class="n">vt</span><span class="p">(:)</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">   </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">get_keys</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">   </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">   </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n</span>
<span class="w">      </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">get</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span>
<span class="w">      </span><span class="k">select type</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
<span class="w">      </span><span class="k">class </span><span class="n">default</span>
<span class="w">         </span><span class="k">call </span><span class="n">ptr</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">      </span><span class="k">class is</span><span class="p">(</span><span class="n">toml_table</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">ptr</span><span class="p">%</span><span class="n">get_keys</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ptr</span><span class="p">%</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">ptr</span><span class="p">%</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">vt</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">get_value</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">prune_value</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">delete</span><span class="p">(</span><span class="n">list</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">key</span><span class="p">)</span>
<span class="w">            </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">push_back</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">         </span><span class="k">else</span>
<span class="k">            call </span><span class="n">ptr</span><span class="p">%</span><span class="k">accept</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
<span class="w">         </span><span class="k">end if</span>
<span class="k">      end select</span>
<span class="k">   end do</span>
<span class="k">end subroutine </span><span class="n">visit_table</span>

<span class="k">subroutine </span><span class="n">prune_value</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">str</span><span class="p">)</span>
<span class="w">   </span><span class="c">!&gt; Actual TOML value</span>
<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">val</span>
<span class="w">   </span><span class="c">!&gt; TOML table to prune</span>
<span class="w">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">   </span><span class="c">!&gt; Value kind</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">tfc</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">str</span>

<span class="w">   </span><span class="k">class</span><span class="p">(</span><span class="n">toml_value</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ptr</span>
<span class="w">   </span><span class="kt">character</span><span class="p">(:,</span><span class="w"> </span><span class="n">tfc</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">sval</span>
<span class="w">   </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>
<span class="nb">   </span><span class="k">type</span><span class="p">(</span><span class="n">toml_datetime</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dval</span>
<span class="w">   </span><span class="kt">integer</span><span class="p">(</span><span class="n">tfi</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ival</span>
<span class="w">   </span><span class="kt">real</span><span class="p">(</span><span class="n">tfr</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fval</span>

<span class="w">   </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ptr</span><span class="p">)</span>
<span class="w">   </span><span class="k">allocate</span><span class="p">(</span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="o">=</span><span class="n">ptr</span><span class="p">)</span>
<span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">table</span><span class="p">%</span><span class="n">key</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">val</span><span class="p">%</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">table</span><span class="p">%</span><span class="n">key</span>
<span class="w">   </span><span class="k">else</span>
<span class="k">      deallocate</span><span class="p">(</span><span class="n">val</span><span class="p">%</span><span class="n">key</span><span class="p">)</span>
<span class="w">   </span><span class="k">end if</span>

<span class="k">   select type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
<span class="w">   </span><span class="k">class is</span><span class="p">(</span><span class="n">toml_keyval</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="n">get</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
<span class="w">      </span><span class="k">select case</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;datetime&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;date-local&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time-local&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;datetime-local&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="n">dval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_datetime</span><span class="p">(</span><span class="n">sval</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="n">dval</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;bool&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="k">call </span><span class="n">val</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="n">sval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="k">read</span><span class="p">(</span><span class="n">sval</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span><span class="w"> </span><span class="n">ival</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">val</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>
<span class="w">         </span><span class="k">end if</span>
<span class="k">      case</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
<span class="w">         </span><span class="k">read</span><span class="p">(</span><span class="n">sval</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">iostat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span><span class="w"> </span><span class="n">fval</span>
<span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            call </span><span class="n">val</span><span class="p">%</span><span class="n">set</span><span class="p">(</span><span class="n">fval</span><span class="p">)</span>
<span class="w">         </span><span class="k">end if</span>
<span class="k">      end select</span>
<span class="k">   end select</span>
<span class="k">end subroutine </span><span class="n">prune_value</span>

<span class="k">end module </span><span class="n">tjson_parser</span>
</pre></div>
</div>
</div>
</div>
</details></section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this heading">#</a></h2>
<p>Now we have a working lexer that can tokenize JSON documents into TOML parsable tokens.
The lexer implemented in TOML Fortran works on a similar construction, with the difference that the TOML grammar is much more complicated to parse than JSON.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In this tutorial, you have learned about the tokenization process used in TOML Fortran.
You can now</p>
<ul class="simple">
<li><p>implement a custom lexer based on the TOML tokens</p></li>
<li><p>verify your lexer against an expected token stream</p></li>
<li><p>adjust the token stream to direct the parsing process</p></li>
<li><p>add a post-processing step to prune the resulting data structure</p></li>
</ul>
</div>
</section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="fpm-lint.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Building a linter</p>
      </div>
    </a>
    <a class="right-next"
       href="../how-to/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How-to guides</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-limitation">Identifying limitation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-lexer">Creating the lexer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#identifying-tokens">Identifying tokens</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extracting-values">Extracting values</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#verifying-the-lexer">Verifying the lexer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#connecting-to-the-parser">Connecting to the parser</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sebastian Ehlert
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2019-2025, Sebastian Ehlert.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>