

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Working with tables &#8212; TOML Fortran</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.4cbf315f70debaebd550c87a6162cf0f.min.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../_static/design-tabs.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/table';</script>
    <link rel="icon" href="../_static/toml-f.svg"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Working with arrays" href="array.html" />
    <link rel="prev" title="Using TOML Fortran" href="integration.html" /> 
<meta
  name="description"
  content="TOML parser implementation for data serialization and deserialization in Fortran"
/>
<meta
  name="keywords"
  content="TOML parser, TOML, serde, Fortran library, Fortran package manager"
/>   
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/toml-f.svg" class="logo__image only-light" alt="TOML Fortran - Home"/>
    <img src="../_static/toml-f.svg" class="logo__image only-dark pst-js-only" alt="TOML Fortran - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">Tutorials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/getting-started.html">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/fpm-lint.html">Building a linter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/json.html">Writing a custom lexer</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">How-Tos</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="installation.html">Installing TOML Fortran</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration.html">Using TOML Fortran</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Working with tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="array.html">Working with arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="error.html">Reporting errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="datetime.html">Date time compatibility</a></li>
<li class="toctree-l2"><a class="reference internal" href="serde.html">Serializable base class</a></li>
<li class="toctree-l2"><a class="reference internal" href="jonquil.html">Compatibility with JSON</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../reference/index.html">References</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://toml.io/en/v1.0.0">TOML specification</a></li>
<li class="toctree-l2"><a class="reference external" href="https://toml-f.github.io/toml-f">API documentation</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../news/index.html">News</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../external.html">External resources</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference external" href="https://cyber.dabamos.de/programming/modernfortran/toml.html">Modern Fortran by Philipp Engel (English)</a></li>
<li class="toctree-l2"><a class="reference external" href="https://fortran-fans.github.io/Fortran-in-Action/Using-Open-Source-Code/Project-Configuration-TOML-F.html">Fortran in Action by Zuo Zhihua (Chinese)</a></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/toml-f/toml-f" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/toml-f/toml-f/edit/main/doc/how-to/table.rst" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Working with tables</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-tables">Accessing tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-nested-tables">Accessing nested tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-access-via-key-paths">Direct access via key paths</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterating-over-keys">Iterating over keys</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#array-of-tables">Array of tables</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                   <section id="working-with-tables">
<h1>Working with tables<a class="headerlink" href="#working-with-tables" title="Permalink to this heading">#</a></h1>
<p>The central data structures in TOML are tables, they contain a map from a key (string) to any supported data type in TOML.
These recipes describe common scenarios for retrieving data from tables using the TOML Fortran library.</p>
<section id="accessing-tables">
<h2>Accessing tables<a class="headerlink" href="#accessing-tables" title="Permalink to this heading">#</a></h2>
<p>When accessing tables there are two main modes, first the default mode which implicitly creates a table if it does not exist yet and second the mode where no tables will be inserted.
The first mode is useful when the presence of a table is optional, for example when reading configuration files where certain features can be activated by providing a subtable with the respective settings.
The second mode is useful when certain tables are mandatory for the program to work correctly.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="k">block</span>
<span class="k">  use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span>

<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">  </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_table</span><span class="p">()</span><span class="w"> </span><span class="c">! create an empty table</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;optional&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">  </span><span class="c">! child pointer is associated, since &quot;optional&quot; table is created implicitly</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect T</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mandatory&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">  </span><span class="c">! child pointer is not associated, since &quot;mandatory&quot; table does not exist</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect F</span>
<span class="k">end block</span>
</pre></div>
</div>
<p>To better distinguish between different results of accessing a table, the status of the operation can be requested as well.
This is useful if the value is present, but the value is not a table.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="k">block</span>
<span class="k">  use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span><span class="p">,</span><span class="w"> </span><span class="n">set_value</span><span class="p">,</span><span class="w"> </span><span class="n">toml_stat</span>

<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>
<span class="w">  </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">  </span><span class="n">table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_table</span><span class="p">()</span><span class="w"> </span><span class="c">! create an empty table</span>
<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;optional&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">  </span><span class="c">! child pointer is associated, since &quot;optional&quot; table is created implicitly</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect T</span>
<span class="w">  </span><span class="c">! status indicates success since the table was created</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="w">  </span><span class="c">! expect T</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;mandatory&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">  </span><span class="c">! child pointer is not associated, since &quot;mandatory&quot; table does not exist</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect F</span>
<span class="w">  </span><span class="c">! status indicates success, since the key is not requested</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="w">  </span><span class="c">! expect T</span>

<span class="w">  </span><span class="k">call </span><span class="n">set_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;not-a-table&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;some string&quot;</span><span class="p">)</span><span class="w">  </span><span class="c">! set a string value</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;not-a-table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">  </span><span class="c">! child pointer is not associated, since &quot;not-a-table&quot; entry is not a table</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect F</span>
<span class="w">  </span><span class="c">! type mismatch is reported in the status</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">type_mismatch</span><span class="w">  </span><span class="c">! expect T</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;not-a-table&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">  </span><span class="c">! child pointer is not associated, since &quot;not-a-table&quot; entry is not a table</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">)</span><span class="w">  </span><span class="c">! expect F</span>
<span class="w">  </span><span class="c">! type mismatch is reported in the status</span>
<span class="w">  </span><span class="k">print</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">type_mismatch</span><span class="w">  </span><span class="c">! expect T</span>
<span class="k">end block</span>
</pre></div>
</div>
<p>If you need absence of a table to be handled, the association status of the returned pointer should be used to check whether the table was present or not.</p>
</section>
<section id="accessing-nested-tables">
<h2>Accessing nested tables<a class="headerlink" href="#accessing-nested-tables" title="Permalink to this heading">#</a></h2>
<p>Using nested tables provides the possibility to better group configuration data.
Since the TOML format always requires the full qualified path in each table header, it is easy for the user to identify where the current settings belong to.
On the other hand, deeply nested tables with long table paths or path components make them more difficult to use and a good balance of short and expressive table names and meaningful subtables is required.</p>
<p>An example of an electronic structure code implementing different Hamiltonians is given below.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[hamiltonian.dftb]</span>
<span class="n">scc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="n">skf</span><span class="p">.</span><span class="n">format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mio-1-1/{}-{}.skf&quot;</span>

<span class="k">[analysis]</span>
<span class="n">calculate-forces</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
</pre></div>
</div>
<p>The deepest nested subtable with entries in this example is the <em>hamiltonian.dftb.skf</em> path.</p>
<p>Such layout in the configuration file will usually be mirrored in the actual implementation, with every table corresponding to a derived type describing the input.
For the example above in total six derived types for the individual tables are defined as</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">src/input.f90</span><a class="headerlink" href="#id1" title="Permalink to this code">#</a></div>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Input for the Slater-Koster integral tables</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skf_input</span>
<span class="w">    </span><span class="c">!&gt; Format string to find Slater-Koster files</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">format_string</span>
<span class="w">    </span><span class="c">! ... more settings for the Slater-Koster input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">skf_input</span>

<span class="w">  </span><span class="c">!&gt; Input for the self-consistent charge iterations</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scc_input</span>
<span class="w">    </span><span class="c">!&gt; Convergence tolerance for energy minimization</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tolerance</span>
<span class="w">    </span><span class="c">! ... more settings for the SCC input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">scc_input</span>

<span class="w">  </span><span class="c">!&gt; Input for DFTB Hamiltonian</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dftb_input</span>
<span class="w">    </span><span class="c">!&gt; Self-consistent field specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">scc_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scc</span>
<span class="w">    </span><span class="c">!&gt; Slater-Koster table specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">skf_input</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skf</span>
<span class="w">    </span><span class="c">! ... more settings for the DFTB input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">dftb_input</span>

<span class="w">  </span><span class="c">!&gt; Input for the Hamiltonian used in the simulation</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hamiltonian_input</span>
<span class="w">    </span><span class="c">!&gt; DFTB Hamiltonian specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">dftb_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dftb</span>
<span class="w">    </span><span class="c">! ... more settings for the Hamiltonian input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">hamiltonian_input</span>

<span class="w">  </span><span class="c">!&gt; Input for analysis of Hamiltonian</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">analysis_input</span>
<span class="w">    </span><span class="c">!&gt; Evaluate derivatives of energy expression</span>
<span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">calculate_forces</span>
<span class="w">    </span><span class="c">! ... more settings for the analysis input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">analysis_input</span>

<span class="w">  </span><span class="c">!&gt; Input for complete simulation</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">simulation_input</span>
<span class="w">    </span><span class="c">!&gt; Hamiltonian used for simulation, always needed</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">hamiltonian_input</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hamiltonian</span>
<span class="w">    </span><span class="c">!&gt; Analysis to run after successful Hamiltonian evaluation</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">analysis_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">analysis</span>
<span class="w">    </span><span class="c">! ... more settings for the simulation input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">simulation_input</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The representation in Fortran derived types looks lengthy compared to the actual TOML input.
Consider that the 40 lines of Fortran code contain 50% comments describing the data types briefly for (future) developers.
Of course, the user documentation of the input format will be much more extensive, containing descriptions for every table and every entry, including input ranges and unit conventions.
The final input file provided by the user can be brief and expressive.</p>
</div>
<p>Staring with the root of the table which is read in the <em>simulation_input</em> there are two ways to obtain access to a subtable, first we get the <em>hamiltonian</em> subtable, which we defined as mandatory, using the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface.
In case it is present a reference will be returned in the <em>child</em> pointer.
If no table is available in the input TOML Fortran will insert it into the root table and return the reference to the newly created table.
The <em>child</em> pointer can still be unassigned in case invalid input is provided, which will result in raising an error in the implementation shown below.</p>
<p>The alternative is to explicitly mark the subtable as optional, like for the <em>analysis</em> table, if no table is available or the entry is invalid the <em>child</em> pointer will not be assigned.
To differentiate those cases we can request the status information, check whether the operation was successful, and cleanly handle the error case.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">src/input.f90</span><a class="headerlink" href="#id2" title="Permalink to this code">#</a></div>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read root document</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_simulation</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Simulation input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">simulation_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No hamiltonian section found in input file&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">hamiltonian</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>

<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No analysis section found in input file&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">analysis</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_analysis</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">analysis</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_simulation</span>
</pre></div>
</div>
</div>
<p>The same happens for reading the <em>hamiltonian_input</em> and <em>dftb_input</em> entry.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">src/input.f90</span><a class="headerlink" href="#id3" title="Permalink to this code">#</a></div>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read Hamiltonian from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Hamiltonian input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">hamiltonian_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dftb&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">dftb</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_dftb</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">dftb</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_hamiltonian</span>

<span class="w">  </span><span class="c">!&gt; Read DFTB Hamiltonian from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_dftb</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; DFTB Hamiltonian input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">dftb_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">scc</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_scc</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">scc</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;skf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No skf section found in dftb table&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">read_skf</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">skf</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_dftb</span>
</pre></div>
</div>
</div>
<p>Finally, we can implement reading the terminal subtables into the <em>scc_input</em>, <em>skf_input</em>, and <em>analysis_input</em>, where we retrieve the actual values using the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface.
Note that we can conveniently define default values using the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface.
For proper error handling, we can retrieve the optional <em>stat</em> argument as well.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">src/input.f90</span><a class="headerlink" href="#id4" title="Permalink to this code">#</a></div>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read SCC from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_scc</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; SCC input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">scc_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tolerance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">tolerance</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-6</span><span class="p">)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_scc</span>

<span class="w">  </span><span class="c">!&gt; Read Slater-Koster files from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_skf</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Slater-Koster input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">skf_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;format-string&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">format_string</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;{}-{}.skf&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_skf</span>

<span class="w">  </span><span class="c">!&gt; Read analysis from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_analysis</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Analysis input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">analysis_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;calculate-forces&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">calculate_forces</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_analysis</span>
</pre></div>
</div>
</div>
<p>For the small incomplete input as shown here, the fine-grained substructure seems overengineered and could be fully defined in the reading routine for the document root as well.
However, for larger program inputs such a structure can help to ensure that input readers are properly modular and reusable.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The allocation status of a component of the derived type can be used instead of a separate boolean flag to indicate whether a feature should be activated.
This avoids requiring conditional code inside a reader routine for conditionally handling entries depending on a boolean flag, instead they can be collected in a subtable.</p>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Full source code</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">The full module implementing the <em>simulation_input</em> reading</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">src/input.f90</span><a class="headerlink" href="#id5" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Input model for a computational chemistry simulation program</span>
<span class="k">module </span><span class="n">demo_input</span>
<span class="w">  </span><span class="k">use </span><span class="n">demo_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">error_type</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">simulation_input</span>

<span class="w">  </span><span class="c">!&gt; Input for the Slater-Koster integral tables</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skf_input</span>
<span class="w">    </span><span class="c">!&gt; Format string to find Slater-Koster files</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">format_string</span>
<span class="w">    </span><span class="c">! ... more settings for the Slater-Koster input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">skf_input</span>

<span class="w">  </span><span class="c">!&gt; Input for the self-consistent charge iterations</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scc_input</span>
<span class="w">    </span><span class="c">!&gt; Convergence tolerance for energy minimization</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tolerance</span>
<span class="w">    </span><span class="c">! ... more settings for the SCC input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">scc_input</span>

<span class="w">  </span><span class="c">!&gt; Input for DFTB Hamiltonian</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dftb_input</span>
<span class="w">    </span><span class="c">!&gt; Self-consistent field specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">scc_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">scc</span>
<span class="w">    </span><span class="c">!&gt; Slater-Koster table specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">skf_input</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">skf</span>
<span class="w">    </span><span class="c">! ... more settings for the DFTB input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">dftb_input</span>

<span class="w">  </span><span class="c">!&gt; Input for the Hamiltonian used in the simulation</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hamiltonian_input</span>
<span class="w">    </span><span class="c">!&gt; DFTB Hamiltonian specific settings</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">dftb_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dftb</span>
<span class="w">    </span><span class="c">! ... more settings for the Hamiltonian input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">hamiltonian_input</span>

<span class="w">  </span><span class="c">!&gt; Input for analysis of Hamiltonian</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">analysis_input</span>
<span class="w">    </span><span class="c">!&gt; Evaluate derivatives of energy expression</span>
<span class="w">    </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">calculate_forces</span>
<span class="w">    </span><span class="c">! ... more settings for the analysis input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">analysis_input</span>

<span class="w">  </span><span class="c">!&gt; Input for complete simulation</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">simulation_input</span>
<span class="w">    </span><span class="c">!&gt; Hamiltonian used for simulation, always needed</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">hamiltonian_input</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">hamiltonian</span>
<span class="w">    </span><span class="c">!&gt; Analysis to run after successful Hamiltonian evaluation</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">analysis_input</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">analysis</span>
<span class="w">    </span><span class="c">! ... more settings for the simulation input</span>
<span class="w">  </span><span class="k">end type </span><span class="n">simulation_input</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Read root document</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_simulation</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Simulation input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">simulation_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No hamiltonian section found in input file&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">hamiltonian</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>

<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;analysis&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.,</span><span class="w"> </span><span class="nb">stat</span><span class="o">=</span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">stat</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">toml_stat</span><span class="p">%</span><span class="n">success</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No analysis section found in input file&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">analysis</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_analysis</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">analysis</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_simulation</span>

<span class="w">  </span><span class="c">!&gt; Read Hamiltonian from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_hamiltonian</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Hamiltonian input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">hamiltonian_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dftb&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">dftb</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_dftb</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">dftb</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_hamiltonian</span>

<span class="w">  </span><span class="c">!&gt; Read DFTB Hamiltonian from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_dftb</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; DFTB Hamiltonian input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">dftb_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scc&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">requested</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      allocate</span><span class="p">(</span><span class="n">input</span><span class="p">%</span><span class="n">scc</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_scc</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">scc</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>
<span class="k">    end if</span>

<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;skf&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;No skf section found in dftb table&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">return</span>
<span class="k">    end if</span>
<span class="k">    call </span><span class="n">read_skf</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">skf</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">return</span>

<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_dftb</span>

<span class="w">  </span><span class="c">!&gt; Read SCC from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_scc</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; SCC input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">scc_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tolerance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">tolerance</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-6</span><span class="p">)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_scc</span>

<span class="w">  </span><span class="c">!&gt; Read Slater-Koster files from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_skf</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Slater-Koster input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">skf_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;format-string&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">format_string</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;{}-{}.skf&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_skf</span>

<span class="w">  </span><span class="c">!&gt; Read analysis from node</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_analysis</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handler</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; Analysis input to be read</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">analysis_input</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">input</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;calculate-forces&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">input</span><span class="p">%</span><span class="n">calculate_forces</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="n">false</span><span class="p">.)</span>
<span class="w">    </span><span class="c">! ... read further values</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_analysis</span>

<span class="k">end module </span><span class="n">demo_input</span>
</pre></div>
</div>
</div>
<p class="sd-card-text">The auxiliary module providing the error handler</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">src/error.f90</span><a class="headerlink" href="#id6" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Central registry for error codes</span>
<span class="k">module </span><span class="n">demo_error</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_type</span><span class="p">,</span><span class="w"> </span><span class="n">fatal_error</span>

<span class="w">  </span><span class="c">!&gt; Possible error codes</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">enum_stat</span>
<span class="w">    </span><span class="c">!&gt; Successful run</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="c">!&gt; Internal error:</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fatal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">end type </span><span class="n">enum_stat</span>

<span class="w">  </span><span class="c">!&gt; Actual enumerator for return states</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">enum_stat</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">demo_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enum_stat</span><span class="p">()</span>

<span class="w">  </span><span class="c">!&gt; Error message</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_type</span>
<span class="w">    </span><span class="c">!&gt; Error code</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>
<span class="w">    </span><span class="c">!&gt; Payload of the error</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>
<span class="w">  </span><span class="k">end type </span><span class="n">error_type</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; A fatal error is encountered</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Instance of the error</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; A detailed message describing the error and (optionally) offering advice</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>
<span class="w">    </span><span class="c">!&gt; Overwrite of the error code</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nb">stat</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">stat</span>
<span class="nb">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">demo_stat</span><span class="p">%</span><span class="n">fatal</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">message</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span>
<span class="w">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Fatal error&quot;</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">fatal_error</span>

<span class="k">end module </span><span class="n">demo_error</span>
</pre></div>
</div>
</div>
</div>
</details></section>
<section id="direct-access-via-key-paths">
<h2>Direct access via key paths<a class="headerlink" href="#direct-access-via-key-paths" title="Permalink to this heading">#</a></h2>
<p>If only a deeply nested value of a data structure is needed it can be retrieved by using a key path.
The build interface will internally walk the key path, resolve the child tables and create them as necessary.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Repeatly accessing values via a key path from the document root, rather than retrieving the reference the desired child table, will introduce an overhead each time the key path is resolved.</p>
</div>
<p>For the previous example we can use the key path access to retrieve the most deeply nested value as shown below.</p>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="k">block</span>
<span class="k">  use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">get_value</span><span class="p">,</span><span class="w"> </span><span class="n">toml_path</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span>
<span class="w">  </span><span class="kt">character</span><span class="p">(:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">format_string</span>

<span class="w">  </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_path</span><span class="p">(</span><span class="s2">&quot;hamiltonian&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;dftb&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;skf&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;format&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">format_string</span><span class="p">)</span>
<span class="k">end block</span>
</pre></div>
</div>
<p>Similar like other build interfaces it can be used to create the subtables as well as the string value by providing a default.</p>
</section>
<section id="iterating-over-keys">
<h2>Iterating over keys<a class="headerlink" href="#iterating-over-keys" title="Permalink to this heading">#</a></h2>
<p>An expressive way to organize data is by providing a table where the keys of each entry describe the object that should be initialized.
For example in a package manager, the keys represent the dependency, where each dependency is declared in a subtable.
Furthermore, a convenience feature might be the possibility to just provide a string, which is interpreted as a version subentry.</p>
<p>The final usage of this in a <em>requirements</em> table could look like the snippet shown below.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[requirements]</span>
<span class="n">stdlib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^0.2.1&quot;</span>
<span class="n">toml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^1.0.0&quot;</span>
<span class="n">cli2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^3.1.0&quot;</span>
<span class="n">lapack</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;^3.10.1&quot;</span>
<span class="n">lapack</span><span class="p">.</span><span class="n">variant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mkl|openblas&quot;</span>
<span class="n">minpack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">git</span><span class="p">=</span><span class="s2">&quot;https://github.com/fortran-lang/minpack@v2.0.0&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>The first three entries provide a string value, while the fourth entry provides a subtable implicitly by using dotted key-value pairs and the last entry uses an inline table.</p>
<p>Here we want to focus on the iteration and the default initialization, the internal structure of the <em>requirement_type</em> is secondary for this example.
We provide the minimal definition only holding the name of the dependency for demonstration purposes.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">src/requirements.f90</span><a class="headerlink" href="#id7" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Declaration of a dependency</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">requirement_type</span>
<span class="w">    </span><span class="c">!&gt; Name to identify dependency</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="c">! ... further declaration of entries</span>
<span class="w">  </span><span class="k">end type </span><span class="n">requirement_type</span>
</pre></div>
</div>
</div>
<p>For the actual implementation of reading all entries from the table, we will use a one-dimensional array of <em>requirement_type</em> values.
Using the <code class="docutils literal notranslate"><span class="pre">get_keys</span></code> method of the table we can obtain a list of all keys for the current table, the method will always allocate the <code class="docutils literal notranslate"><span class="pre">list</span></code> variable and we can safely allocate the <em>requirement_type</em> using the number of keys.
To obtain the subtable, the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface can be used, it will return a pointer to the subtable, either created implicitly by using a dotted key-value pair or by an inline table as shown in the snippet above.
Finally, we can call the actual constructor of the <em>requirement_type</em> using the subtable references with the <code class="docutils literal notranslate"><span class="pre">child</span></code> pointer.</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">src/requirements.f90</span><a class="headerlink" href="#id8" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Create a new list of requirements from a table</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">new_requirements</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handling</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; List of all dependencies</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">requirement_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">req</span><span class="p">(:)</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">target</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dummy</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">version</span>

<span class="w">    </span><span class="c">! Get all entries of current table, the `list` is guaranteed to be allocated</span>
<span class="w">    </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">get_keys</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">req</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">)))</span>

<span class="w">    </span><span class="k">do </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>

<span class="w">      </span><span class="c">! Not providing a subtable is okay if a string provides the version constraint</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">        call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">version</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Requirement &#39;&quot;</span><span class="o">//</span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">)%</span><span class="n">key</span><span class="o">//</span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;&#39; must be version constraint or subtable&quot;</span><span class="p">)</span>
<span class="w">          </span><span class="k">exit</span>
<span class="k">        end if</span>

<span class="w">        </span><span class="c">! Create a dummy table we can reference when initializing</span>
<span class="w">        </span><span class="n">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_table</span><span class="p">()</span>
<span class="w">        </span><span class="k">call </span><span class="n">set_value</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">)</span>
<span class="w">        </span><span class="n">child</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dummy</span>
<span class="w">      </span><span class="k">end if</span>

<span class="w">      </span><span class="c">! Initialize dependency from subtable</span>
<span class="w">      </span><span class="k">call </span><span class="n">new_requirement</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">)%</span><span class="n">key</span><span class="p">)</span>

<span class="w">      </span><span class="c">! Cleanup, alternatively the dummy could be pushed back into the main table</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">dummy</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
<span class="w">      </span><span class="c">! Leave loop in case of error</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="k">    end do</span>
<span class="w">    </span><span class="c">! Requirements are in a half-finished state, invalidate them to avoid confusion</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">new_requirements</span>
</pre></div>
</div>
</div>
<p>The other scenario we want to support is the presence of a string rather than a subtable.
In this case, the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface will fail, while it provides an optional status argument to check for successful operation, we can more conveniently and idiomatically verify the success by checking the state of the <code class="docutils literal notranslate"><span class="pre">child</span></code> pointer.
If there is no subtable to reference, <em>i.e.</em> because it is a key-value pair with a string entry, the <code class="docutils literal notranslate"><span class="pre">child</span></code> pointer will not be associated, which can be easily checked.
For this case we will again use the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface, but this time to retrieve the entry into a deferred length character.
Again we can idiomatically check the status of the operation using the allocation state of the variable and create the appropriate error message if needed.
Eventually, we have to provide the constructor of the requirements with a table, for this purpose we create a dummy table and set the entry at the version key to the just retrieved string.
The newly created dummy table can be associated with the <code class="docutils literal notranslate"><span class="pre">child</span></code> pointer and passed to the actual constructor.</p>
<p>The actual constructor for our example is very minimalistic and only recovers the name of the dependency which is passed as a separate argument.</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text">src/requirements.f90</span><a class="headerlink" href="#id9" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Initialize a dependency from a TOML data structure</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">new_requirement</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handling</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; New dependency object</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">requirement_type</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">req</span>
<span class="w">    </span><span class="c">!&gt; Name of the dependency</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name</span>

<span class="w">    </span><span class="n">req</span><span class="p">%</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="c">! ... further reading of entries</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">new_requirement</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While we provide an error handler in the example, we also ensure that the allocation status of the <em>requirement_type</em> values communicates the status of the operation as well.</p>
</div>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Full source code</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">The full module implementing the <em>requirement_type</em> reading</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text">src/requirements.f90</span><a class="headerlink" href="#id10" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Defines a simple dependency type to express requirements of a project.</span>
<span class="k">module </span><span class="n">demo_requirements</span>
<span class="w">  </span><span class="k">use </span><span class="n">demo_error</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">error_type</span><span class="p">,</span><span class="w"> </span><span class="n">fatal_error</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_key</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span><span class="p">,</span><span class="w"> </span><span class="n">set_value</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">requirement_type</span><span class="p">,</span><span class="w"> </span><span class="n">new_requirement</span><span class="p">,</span><span class="w"> </span><span class="n">new_requirements</span>

<span class="w">  </span><span class="c">!&gt; Declaration of a dependency</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">requirement_type</span>
<span class="w">    </span><span class="c">!&gt; Name to identify dependency</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="c">! ... further declaration of entries</span>
<span class="w">  </span><span class="k">end type </span><span class="n">requirement_type</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Create a new list of requirements from a table</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">new_requirements</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handling</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; List of all dependencies</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">requirement_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">req</span><span class="p">(:)</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ikey</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_key</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">list</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">target</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">dummy</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">version</span>

<span class="w">    </span><span class="c">! Get all entries of current table, the `list` is guaranteed to be allocated</span>
<span class="w">    </span><span class="k">call </span><span class="n">table</span><span class="p">%</span><span class="n">get_keys</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">req</span><span class="p">(</span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">)))</span>

<span class="w">    </span><span class="k">do </span><span class="n">ikey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">list</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>

<span class="w">      </span><span class="c">! Not providing a subtable is okay if a string provides the version constraint</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="nb">associated</span><span class="p">(</span><span class="n">child</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">        call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">version</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">version</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">          call </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Requirement &#39;&quot;</span><span class="o">//</span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">)%</span><span class="n">key</span><span class="o">//</span><span class="p">&amp;</span>
<span class="w">            </span><span class="p">&amp;</span><span class="w"> </span><span class="s2">&quot;&#39; must be version constraint or subtable&quot;</span><span class="p">)</span>
<span class="w">          </span><span class="k">exit</span>
<span class="k">        end if</span>

<span class="w">        </span><span class="c">! Create a dummy table we can reference when initializing</span>
<span class="w">        </span><span class="n">dummy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">toml_table</span><span class="p">()</span>
<span class="w">        </span><span class="k">call </span><span class="n">set_value</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;version&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">)</span>
<span class="w">        </span><span class="n">child</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">dummy</span>
<span class="w">      </span><span class="k">end if</span>

<span class="w">      </span><span class="c">! Initialize dependency from subtable</span>
<span class="w">      </span><span class="k">call </span><span class="n">new_requirement</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">(</span><span class="n">ikey</span><span class="p">),</span><span class="w"> </span><span class="n">list</span><span class="p">(</span><span class="n">ikey</span><span class="p">)%</span><span class="n">key</span><span class="p">)</span>

<span class="w">      </span><span class="c">! Cleanup, alternatively the dummy could be pushed back into the main table</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">dummy</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span>
<span class="w">      </span><span class="c">! Leave loop in case of error</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">exit</span>
<span class="k">    end do</span>
<span class="w">    </span><span class="c">! Requirements are in a half-finished state, invalidate them to avoid confusion</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">error</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">new_requirements</span>

<span class="w">  </span><span class="c">!&gt; Initialize a dependency from a TOML data structure</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">new_requirement</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">req</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Error handling</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; TOML data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; New dependency object</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">requirement_type</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">req</span>
<span class="w">    </span><span class="c">!&gt; Name of the dependency</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">name</span>

<span class="w">    </span><span class="n">req</span><span class="p">%</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span>
<span class="w">    </span><span class="c">! ... further reading of entries</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">new_requirement</span>

<span class="k">end module </span><span class="n">demo_requirements</span>
</pre></div>
</div>
</div>
<p class="sd-card-text">The auxiliary module providing the error handler</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text">src/error.f90</span><a class="headerlink" href="#id11" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Central registry for error codes</span>
<span class="k">module </span><span class="n">demo_error</span>
<span class="w">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_type</span><span class="p">,</span><span class="w"> </span><span class="n">fatal_error</span>

<span class="w">  </span><span class="c">!&gt; Possible error codes</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">enum_stat</span>
<span class="w">    </span><span class="c">!&gt; Successful run</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">success</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="c">!&gt; Internal error:</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">fatal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="k">end type </span><span class="n">enum_stat</span>

<span class="w">  </span><span class="c">!&gt; Actual enumerator for return states</span>
<span class="w">  </span><span class="k">type</span><span class="p">(</span><span class="n">enum_stat</span><span class="p">),</span><span class="w"> </span><span class="k">parameter</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">demo_stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enum_stat</span><span class="p">()</span>

<span class="w">  </span><span class="c">!&gt; Error message</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error_type</span>
<span class="w">    </span><span class="c">!&gt; Error code</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>
<span class="w">    </span><span class="c">!&gt; Payload of the error</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>
<span class="w">  </span><span class="k">end type </span><span class="n">error_type</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; A fatal error is encountered</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">fatal_error</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="nb">stat</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Instance of the error</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">error_type</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">error</span>
<span class="w">    </span><span class="c">!&gt; A detailed message describing the error and (optionally) offering advice</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=*</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">message</span>
<span class="w">    </span><span class="c">!&gt; Overwrite of the error code</span>
<span class="w">    </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="w"> </span><span class="k">optional</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="nb">stat</span>

<span class="nb">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="nb">stat</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">stat</span>
<span class="nb">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="nb">stat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">demo_stat</span><span class="p">%</span><span class="n">fatal</span>
<span class="w">    </span><span class="k">end if</span>

<span class="k">    if</span><span class="w"> </span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">message</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span>
<span class="w">    </span><span class="k">else</span>
<span class="k">      </span><span class="n">error</span><span class="p">%</span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Fatal error&quot;</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">  end subroutine </span><span class="n">fatal_error</span>

<span class="k">end module </span><span class="n">demo_error</span>
</pre></div>
</div>
</div>
</div>
</details></section>
<section id="array-of-tables">
<h2>Array of tables<a class="headerlink" href="#array-of-tables" title="Permalink to this heading">#</a></h2>
<p>A special construct in TOML is the array of tables syntax, it provides a more verbose form to declare several tables in an array, which are usually provided using inline tables as shown below.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="n">tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">   </span><span class="p">{</span><span class="n">name</span><span class="p">=</span><span class="s2">&quot;optimization&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">=</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">},</span>
<span class="w">   </span><span class="p">{</span><span class="n">name</span><span class="p">=</span><span class="s2">&quot;equilibration&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">=</span><span class="s2">&quot;velocity-verlet&quot;</span><span class="p">},</span>
<span class="w">   </span><span class="p">{</span><span class="n">name</span><span class="p">=</span><span class="s2">&quot;production&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">=</span><span class="s2">&quot;velocity-verlet&quot;</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>Comparing the above example to the snippet below using an array of tables for the <em>tasks</em> array, the more verbose form becomes preferable in case further subtables are needed.
Except for the subtables <em>config</em> the same data is provided.</p>
<div class="highlight-toml notranslate"><div class="highlight"><pre><span></span><span class="k">[[tasks]]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;optimization&quot;</span>
<span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;lbfgs&quot;</span>
<span class="k">[task.config]</span>
<span class="n">tolerance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-7</span>

<span class="k">[[tasks]]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;equilibration&quot;</span>
<span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;velocity-verlet&quot;</span>
<span class="k">[task.config]</span>
<span class="n">time-step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300.0</span>
<span class="n">max-steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">500</span>

<span class="k">[[tasks]]</span>
<span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;production&quot;</span>
<span class="n">driver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;velocity-verlet&quot;</span>
<span class="k">[task.config]</span>
<span class="n">time-step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span>
<span class="n">temperature</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">300.0</span>
<span class="n">max-steps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span>
</pre></div>
</div>
<p>To represent this data we can use a single <em>task_config</em> derived type with a polymorphic <em>driver_config</em> member identifying the actual task.
For this example, we will have two implementations of such tasks such as LBFGS and Velocity Verlet, which are defined in the following snippets.</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text">src/task.f90</span><a class="headerlink" href="#id12" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Abstract base class for all simulation driver configurations</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">abstract</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">driver_config</span>
<span class="w">  </span><span class="k">end type </span><span class="n">driver_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration for the LBFGS geometry optimization driver</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">driver_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lbfgs_config</span>
<span class="w">    </span><span class="c">!&gt; Tolerance for considering optimization to be converged</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tolerance</span>
<span class="w">  </span><span class="k">end type </span><span class="n">lbfgs_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration for the Velocity-Verlet molecular dynamics driver</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">driver_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">velocity_verlet_config</span>
<span class="w">    </span><span class="c">!&gt; Time step for the propagation in fs</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">time_step</span>
<span class="w">    </span><span class="c">!&gt; Temperature in K</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temperature</span>
<span class="w">    </span><span class="c">!&gt; Number of steps to take in the propagation</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">max_steps</span>
<span class="w">  </span><span class="k">end type </span><span class="n">velocity_verlet_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration of a single simulation task</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task_config</span>
<span class="w">    </span><span class="c">!&gt; Label to identify the task</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">label</span>
<span class="w">    </span><span class="c">!&gt; Driver configuration</span>
<span class="w">    </span><span class="k">class</span><span class="p">(</span><span class="n">driver_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">  </span><span class="k">end type </span><span class="n">task_config</span>
</pre></div>
</div>
</div>
<p>To read the array of tables we start from the root document and fetch the <em>tasks</em> entry as an array using the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface.
The length of the full arrays is known and we can use it to allocate the list of <em>task_config</em> values before reading the individual entries.
The individual tables inside the array can be addressed using the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface by passing the (one-based) index.</p>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text">src/task.f90</span><a class="headerlink" href="#id13" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read task configurations from document root</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_tasks</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configurations for simulation tasks</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">task_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task</span><span class="p">(:)</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">itask</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_array</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">array</span>
<span class="k">    type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="p">)</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">task</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="k">array</span><span class="p">)))</span>

<span class="w">    </span><span class="k">do </span><span class="n">itask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="k">array</span><span class="p">,</span><span class="w"> </span><span class="n">itask</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_task</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">(</span><span class="n">itask</span><span class="p">))</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">  end subroutine </span><span class="n">read_tasks</span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the setup above, if the <em>tasks</em> entry is not present it will be implicitly created as an empty array.
The allocation and the loop over the entries will work, however the consuming code should check whether no tasks are meaningful or should produce an error.</p>
</div>
<p>To read the individual tasks we define a separate procedure to make it easily reusable and hide the fact that we are working with a subtable.
To make the task <em>name</em> optional we make it default to the driver name, for <em>allocatable</em> or <em>pointer</em> variables the exit status of <code class="docutils literal notranslate"><span class="pre">get_value</span></code> can be easily checked by the allocation or association status of the respective variable, alternatively an integer variable can be passed to the optional <em>stat</em> argument.
Finally, the configuration reader is called depending on the value of <em>driver</em> for ease of usage we use a block construct to allocate the specific type and then transfer it using <em>move_alloc</em> into the <em>task_config</em>.</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text">src/task.f90</span><a class="headerlink" href="#id14" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read a single task configuration</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_task</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for simulation task</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">task_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task</span>

<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">driver</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;driver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">driver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      error stop</span><span class="w"> </span><span class="s2">&quot;Driver keyword not present in task configuration&quot;</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">)</span>

<span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
<span class="w">    </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="k">error stop</span><span class="w"> </span><span class="s2">&quot;Unknown driver type in task configuration&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">block</span>
<span class="k">        type</span><span class="p">(</span><span class="n">lbfgs_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">read_lbfgs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">config</span><span class="p">)</span>
<span class="w">      </span><span class="k">end block</span>
<span class="k">    case</span><span class="p">(</span><span class="s2">&quot;velocity-verlet&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">block</span>
<span class="k">        type</span><span class="p">(</span><span class="n">velocity_verlet_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">read_velocity_verlet</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">config</span><span class="p">)</span>
<span class="w">      </span><span class="k">end block</span>
<span class="k">    end select</span>
<span class="k">  end subroutine </span><span class="n">read_task</span>
</pre></div>
</div>
</div>
<p>For reading the actual driver configuration we use the <code class="docutils literal notranslate"><span class="pre">get_value</span></code> interface to obtain the settings.
We use the same defaulting mechanism as for the <em>name</em> entry here.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<div class="code-block-caption"><span class="caption-text">src/task.f90</span><a class="headerlink" href="#id15" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="c">!&gt; Read configuration for LBFGS geometry optimization</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_lbfgs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for LBFGS optimizer</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lbfgs_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tolerance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">tolerance</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-6</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_lbfgs</span>

<span class="w">  </span><span class="c">!&gt; Read configuration for Velocity-Verlet molecular dynamics</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_velocity_verlet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for Velocity-Verlet propagator</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">velocity_verlet_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time-step&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">time_step</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="mf">8.15</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;max-steps&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">max_steps</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_velocity_verlet</span>
</pre></div>
</div>
</div>
<p>Note that this example does not propagate back errors but directly calls <em>error stop</em>, for a more robust error reporting this can be changed by a small error handle or a context type.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text">Full source code</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">The full module implementing the <em>task_config</em> reading</p>
<div class="literal-block-wrapper docutils container" id="id16">
<div class="code-block-caption"><span class="caption-text">src/task.f90</span><a class="headerlink" href="#id16" title="Permalink to this code">#</a></div>
<div class="highlight-fortran notranslate"><div class="highlight"><pre><span></span><span class="c">!&gt; Example for a workflow pipeline to construct a molecular dynamics simulation.</span>
<span class="k">module </span><span class="n">demo_task</span>
<span class="w">  </span><span class="k">use </span><span class="n">tomlf</span><span class="p">,</span><span class="w"> </span><span class="k">only</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">toml_table</span><span class="p">,</span><span class="w"> </span><span class="n">toml_array</span><span class="p">,</span><span class="w"> </span><span class="n">get_value</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span>
<span class="nb">  </span><span class="k">implicit none</span>
<span class="k">  private</span>

<span class="k">  public</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">read_tasks</span><span class="p">,</span><span class="w"> </span><span class="n">task_config</span><span class="p">,</span><span class="w"> </span><span class="n">driver_config</span><span class="p">,</span><span class="w"> </span><span class="n">lbfgs_config</span><span class="p">,</span><span class="w"> </span><span class="n">velocity_verlet_config</span>

<span class="w">  </span><span class="c">!&gt; Abstract base class for all simulation driver configurations</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">abstract</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">driver_config</span>
<span class="w">  </span><span class="k">end type </span><span class="n">driver_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration for the LBFGS geometry optimization driver</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">driver_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">lbfgs_config</span>
<span class="w">    </span><span class="c">!&gt; Tolerance for considering optimization to be converged</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tolerance</span>
<span class="w">  </span><span class="k">end type </span><span class="n">lbfgs_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration for the Velocity-Verlet molecular dynamics driver</span>
<span class="w">  </span><span class="k">type</span><span class="p">,</span><span class="w"> </span><span class="k">extends</span><span class="p">(</span><span class="n">driver_config</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">velocity_verlet_config</span>
<span class="w">    </span><span class="c">!&gt; Time step for the propagation in fs</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">time_step</span>
<span class="w">    </span><span class="c">!&gt; Temperature in K</span>
<span class="w">    </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temperature</span>
<span class="w">    </span><span class="c">!&gt; Number of steps to take in the propagation</span>
<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">max_steps</span>
<span class="w">  </span><span class="k">end type </span><span class="n">velocity_verlet_config</span>

<span class="w">  </span><span class="c">!&gt; Configuration of a single simulation task</span>
<span class="w">  </span><span class="k">type</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task_config</span>
<span class="w">    </span><span class="c">!&gt; Label to identify the task</span>
<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">label</span>
<span class="w">    </span><span class="c">!&gt; Driver configuration</span>
<span class="w">    </span><span class="k">class</span><span class="p">(</span><span class="n">driver_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>
<span class="w">  </span><span class="k">end type </span><span class="n">task_config</span>

<span class="k">contains</span>

<span class="w">  </span><span class="c">!&gt; Read task configurations from document root</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_tasks</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configurations for simulation tasks</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">task_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="p">,</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task</span><span class="p">(:)</span>

<span class="w">    </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">itask</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_array</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="k">array</span>
<span class="k">    type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tasks&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">array</span><span class="p">)</span>
<span class="w">    </span><span class="k">allocate</span><span class="p">(</span><span class="n">task</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="k">array</span><span class="p">)))</span>

<span class="w">    </span><span class="k">do </span><span class="n">itask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="k">array</span><span class="p">,</span><span class="w"> </span><span class="n">itask</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">      </span><span class="k">call </span><span class="n">read_task</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">(</span><span class="n">itask</span><span class="p">))</span>
<span class="w">    </span><span class="k">end do</span>
<span class="k">  end subroutine </span><span class="n">read_tasks</span>

<span class="w">  </span><span class="c">!&gt; Read a single task configuration</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_task</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for simulation task</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">task_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">task</span>

<span class="w">    </span><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="p">:),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">driver</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">pointer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">child</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;driver&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">driver</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">      error stop</span><span class="w"> </span><span class="s2">&quot;Driver keyword not present in task configuration&quot;</span>
<span class="w">    </span><span class="k">end if</span>
<span class="k">    call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">driver</span><span class="p">)</span>

<span class="w">    </span><span class="k">select case</span><span class="p">(</span><span class="n">driver</span><span class="p">)</span>
<span class="w">    </span><span class="k">case </span><span class="n">default</span>
<span class="w">      </span><span class="k">error stop</span><span class="w"> </span><span class="s2">&quot;Unknown driver type in task configuration&quot;</span>
<span class="w">    </span><span class="k">case</span><span class="p">(</span><span class="s2">&quot;lbfgs&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">block</span>
<span class="k">        type</span><span class="p">(</span><span class="n">lbfgs_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">read_lbfgs</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">config</span><span class="p">)</span>
<span class="w">      </span><span class="k">end block</span>
<span class="k">    case</span><span class="p">(</span><span class="s2">&quot;velocity-verlet&quot;</span><span class="p">)</span>
<span class="w">      </span><span class="k">block</span>
<span class="k">        type</span><span class="p">(</span><span class="n">velocity_verlet_config</span><span class="p">),</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">tmp</span>
<span class="w">        </span><span class="k">allocate</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;config&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="n">read_velocity_verlet</span><span class="p">(</span><span class="n">child</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">)</span>
<span class="w">        </span><span class="k">call </span><span class="nb">move_alloc</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">%</span><span class="n">config</span><span class="p">)</span>
<span class="w">      </span><span class="k">end block</span>
<span class="k">    end select</span>
<span class="k">  end subroutine </span><span class="n">read_task</span>

<span class="w">  </span><span class="c">!&gt; Read configuration for LBFGS geometry optimization</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_lbfgs</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for LBFGS optimizer</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">lbfgs_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;tolerance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">tolerance</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-6</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_lbfgs</span>

<span class="w">  </span><span class="c">!&gt; Read configuration for Velocity-Verlet molecular dynamics</span>
<span class="w">  </span><span class="k">subroutine </span><span class="n">read_velocity_verlet</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="c">!&gt; Data structure</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">toml_table</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">table</span>
<span class="w">    </span><span class="c">!&gt; Configuration for Velocity-Verlet propagator</span>
<span class="w">    </span><span class="k">type</span><span class="p">(</span><span class="n">velocity_verlet_config</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">config</span>

<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;time-step&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">time_step</span><span class="p">,</span><span class="w"> </span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">temperature</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="mf">8.15</span><span class="p">)</span>
<span class="w">    </span><span class="k">call </span><span class="n">get_value</span><span class="p">(</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;max-steps&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">%</span><span class="n">max_steps</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>
<span class="w">  </span><span class="k">end subroutine </span><span class="n">read_velocity_verlet</span>

<span class="k">end module </span><span class="n">demo_task</span>
</pre></div>
</div>
</div>
</div>
</details></section>
</section>

<div class="section ablog__blog_comments">
   
</div>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="integration.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Using TOML Fortran</p>
      </div>
    </a>
    <a class="right-next"
       href="array.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Working with arrays</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-tables">Accessing tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-nested-tables">Accessing nested tables</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#direct-access-via-key-paths">Direct access via key paths</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterating-over-keys">Iterating over keys</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#array-of-tables">Array of tables</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sebastian Ehlert
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2019-2025, Sebastian Ehlert.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>